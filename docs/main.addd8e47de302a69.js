(self.webpackChunkapp=self.webpackChunkapp||[]).push([[179],{2518:($,V,c)=>{"use strict";c.d(V,{U:()=>oe});var I=c(1670),v=c(5568),N=c(2135),z=c(6903),Q=c(8987),Y=c(190),q=c(4666),C=c(2340),Z=c(8211),s=c(7728),n=c(5009),l=c.n(n),d=c(2162),p=c(875),G=c(6476),m=c(2004),f=c(8139);d.Z.enc.Hex.parse("101112131415161718191a1b1c1d1e1f");const y="~vodle.user.",b="~vodle.poll.";function _(P){return"poll."+P+"."}const D=["local_language","email","password","db","db_from_pid","db_other_server_url","db_custom_password","db_server_url","db_password"],x=["email","password","db","db_from_pid","db_from_pid_server_url","db_from_pid_password","db_other_server_url","db_custom_password"],S=["creator","db","db_from_pid","db_other_server_url","db_custom_password","db_server_url","db_password","password","myvid","del_private_key","del_nickname","del_from","have_seen","have_acted","has_been_notified_of_end","has_results","have_seen_results","poll_page","simulated_ratings","final_rand","winner"],A=["consent","last_access"],M=["state","option"],W=["rating","del_request","del_response"],R=new TextEncoder;function J(P,B){try{return d.Z.AES.encrypt(""+P,B).toString()}catch{return null}}function H(P,B){try{return d.Z.AES.decrypt(P,B).toString(d.Z.enc.Utf8)}catch{return null}}function X(P){const B=new(l())(C.N.data_service.hash_n_bytes);return B.update(R.encode(P.toString())),B.hexDigest()}const k=["user_cache","_pids","_pid_oids","poll_caches","own_ratings_map_caches","proxy_ratings_map_caches","effective_ratings_map_caches","max_proxy_ratings_map_caches","argmax_proxy_ratings_map_caches","outgoing_dids_caches","incoming_dids_caches","delegation_agreements_caches","direct_delegation_map_caches","inv_direct_delegation_map_caches","indirect_delegation_map_caches","inv_indirect_delegation_map_caches","effective_delegation_map_caches","inv_effective_delegation_map_caches","tally_caches","news_keys"];let se=(()=>{class P{constructor(e,t,i,a,r,o){this.router=e,this.loadingController=t,this.alertCtrl=i,this.translate=a,this.storage=r,this.document=o,this.restored_user_cache=!1,this.restored_poll_caches=!1,this.can_notify=!1,this._ready=!1,this._loading=!1,this.need_poll_db_replication={},this.pending_changes=0}get pids(){return this._pids}get ready(){return this._ready}get loading(){return this._loading}ionViewWillLeave(){this.save_state()}ngOnDestroy(){console.log("DataService.ngOnDestroy entry"),this.save_state(),console.log("DataService.ngOnDestroy exit")}save_state(){this.G.L.entry("DataService.save_state");const e={};for(const t of k)e[t]=this[t];return this.G.L.exit("DataService.save_state"),this.storage?this.storage.set("state",e):null}init(e){e.L.entry("DataService.init"),this.G=e,this.show_loading(),this.user_cache={},this._pids=new Set,this._pid_oids={},this.poll_caches={},this.tally_caches={},this.own_ratings_map_caches={},this.outgoing_dids_caches={},this.incoming_dids_caches={},this.delegation_agreements_caches={},this.direct_delegation_map_caches={},this.inv_direct_delegation_map_caches={},this.indirect_delegation_map_caches={},this.inv_indirect_delegation_map_caches={},this.effective_delegation_map_caches={},this.inv_effective_delegation_map_caches={},this.proxy_ratings_map_caches={},this.max_proxy_ratings_map_caches={},this.argmax_proxy_ratings_map_caches={},this.effective_ratings_map_caches={},this.news_keys=new Set,this.storage.create(),this.storage.get("state").then(t=>{if(t){e.L.debug("DataService got state from storage");for(const i of k)i in t&&null!=t[i]?(this[i]=t[i],e.L.trace("DataService restored attribute",i,"from storage")):e.L.warn("DataService couldn't find attribute",i,"in storage");"user_cache"in t&&(this.restored_user_cache=!0),"_pids"in t&&"poll_caches"in t&&(this.restored_poll_caches=!0),this.G.L.trace("DataService.init _pids",JSON.stringify(this._pids)),this.G.L.trace("DataService.init _pid_oids",JSON.stringify(this._pid_oids));for(const i in this._pid_oids)this.G.L.trace("DataService.init _pid_oids",i,[...this._pid_oids[i]])}else e.L.warn("DataService could not get state from storage (empty)",t)}).catch(t=>{e.L.warn("DataService could not get state from storage:",t)}).finally(()=>{this.init_databases()}),this.init_notifications(!1),this.test_sodium.bind(this)(),e.L.exit("DataService.init")}init_databases(){this.G.L.entry("DataService.init_databases"),this.local_only_user_DB=new s("local_only_user",{auto_compaction:!0}),this.local_synced_user_db=new s("local_synced_user",{auto_compaction:!0}),this.uninitialized_pids=new Set,this.local_poll_dbs={},this.remote_poll_dbs={},this.poll_db_sync_handlers={},this.restored_user_cache?this.after_local_only_user_cache_is_filled():(this.user_cache={},this.local_only_user_DB.allDocs({include_docs:!0}).then(this.process_local_only_user_docs.bind(this)).catch(e=>{this.G.L.error(e)})),this.G.L.exit("DataService.init_databases")}process_local_only_user_docs(e){this.G.L.entry("DataService.process_local_only_user_docs");for(const t of e.rows){const i=t.doc,a=i._id,r=i.value;if(this.user_cache[a]=r,this.G.L.trace("DataService.process_local_only_user_docs filled user cache with key",a,"and value",r),"local_language"==a){const o=""!=(r||"")?r:C.N.default_lang;this.translate.use(o),this.document.documentElement.lang=o}}this.after_local_only_user_cache_is_filled(),this.G.L.exit("DataService.process_local_only_user_docs")}after_local_only_user_cache_is_filled(){if(this.G.L.entry("DataService.after_user_cache_is_filled"),""==(this.user_cache.email||"")||""==(this.user_cache.password||"")){if(this.G.L.info("DataService found empty email or password, redirecting to login page."),this.hide_loading(),!this.router.url.includes("/login")){const e=encodeURIComponent(this.router.url);this.router.navigate([""==(this.user_cache.local_language||"")?"/login/start/"+e:"/login/used_before/"+e])}}else this.email_and_password_exist();this.G.L.exit("DataService.after_user_cache_is_filled")}email_and_password_exist(){this.G.L.entry("DataService.email_and_password_exist: email",this.user_cache.email,", password",this.user_cache.password),this.restored_user_cache?this.init_poll_data():this.local_synced_user_db.allDocs({include_docs:!0}).then(e=>{this.local_user_docs2cache.bind(this)(e)}).catch(e=>{this.G.L.error("DataService could not read local_synced_user_DB",e)}),this.has_user_db_credentials()?this.connect_to_remote_user_db().then(e=>{this.router.url.includes("/login")&&(this.G.remove_spinning_reason("login"),this.router.navigate(["/login/connected/"+(this.page&&this.page.then_url||"")]))}).catch(e=>{this.G.L.warn("DataService could not connect to remote user db",e)}):(this.G.L.warn("DataService found insufficient db credentials, redirecting to login page."),this.router.navigate(["/login/db_credentials/missing"])),this.G.L.exit("DataService.email_and_password_exist")}init_poll_data(){if(!this.restored_poll_caches){let e=!1;for(const t in this.user_cache)this.check_whether_poll_or_option(t,this.user_cache[t])&&(e=!0)}this.local_docs2cache_finished()}has_user_db_credentials(){return this.G.S.compute_db_credentials(),""!=this.getu("db_server_url")&&""!=this.getu("db_password")}local_user_docs2cache(e){this.G.L.entry("DataService.local_user_docs2cache");let t=!1;for(const i of e.rows){const[a,r]=this.doc2user_cache(i.doc);t=t||r}t||this.local_docs2cache_finished(),this.G.L.exit("DataService.local_user_docs2cache")}connect_to_remote_user_db(){this.G.L.entry("DataService.connect_to_remote_user_db");const e=this.user_cache.password,t="vodle.user."+this.get_email_and_pw_hash(),i=new Promise((a,r)=>{this.get_remote_connection(this.getu("db_server_url"),this.getu("db_password"),t,e).then(o=>{this.remote_user_db=o,this.start_user_sync();const h=new Date;this.setu("last_access",h.getUTCFullYear()+"/"+String(h.getUTCMonth()+1).padStart(2,"0")),a(!0)}).catch(o=>{this.G.L.warn("DataService.connect_to_remote_user_db failed, redirecting to login page",o),this.router.navigate(["/login/db_credentials/failed"]),r(o)})});return this.G.L.exit("DataService.connect_to_remote_user_db"),i}get_local_poll_db(e){return e in this.local_poll_dbs||(this.local_poll_dbs[e]=new s("local_poll_"+e,{auto_compaction:!0}),this.G.L.info("DataService.get_local_poll_db new poll db",e,this.local_poll_dbs[e]),this.need_poll_db_replication[e]=!0),this.local_poll_dbs[e]}ensure_local_poll_data(e){this.G.L.entry("DataService.ensure_local_poll_data",e),this._ready=!1,this.uninitialized_pids.add(e),this.ensure_poll_cache(e);const t=this.get_local_poll_db(e);"state"in this.poll_caches[e]?(this.G.L.trace("DataService.ensure_local_poll_data nothing to do",e),this._pids.add(e)):t.allDocs({include_docs:!0}).then(i=>{this.local_poll_docs2cache.bind(this)(e,i)}).catch(i=>{this.G.L.error("DataService.ensure_local_poll_data could not fetch all docs",e,i)}).finally(()=>{this.uninitialized_pids.delete(e),this.G.L.trace("DataService.ensure_local_poll_data no. of still uninitialized pids:",this.uninitialized_pids.size),0==this.uninitialized_pids.size&&this.local_docs2cache_finished()}),this.G.L.exit("DataService.ensure_local_poll_data",e)}local_poll_docs2cache(e,t){this.G.L.entry("DataService.local_poll_docs2cache",e);let i=!1;for(const a of t.rows)i=i||this.doc2poll_cache(e,a.doc);this._pids.add(e),i&&this.save_state(),this.G.L.exit("DataService.local_poll_docs2cache",e)}get_user_doc_selector(e){return{_id:{$gte:y+e+"\xa7",$lt:y+e+"\xa8"}}}get_poll_doc_selector(e){return{$or:[{_id:{$gte:b+e+"\xa7",$lt:b+e+"\xa8"}},{_id:{$gte:b+e+".voter.",$lt:b+e+".voter/"}}]}}connect_to_remote_poll_db(e,t=!1){this.G.L.entry("DataService.connect_to_remote_poll_db",e,t);const i="vodle.poll."+e+".voter."+this.getp(e,"myvid");var a;return a=new Promise(t?(r,o)=>{this.get_remote_connection(this.getp(e,"db_server_url"),this.getp(e,"db_password"),i,this.G.S.password).then(h=>{this.remote_poll_dbs[e]=h,this.G.L.trace("DataService.connect_to_remote_poll_db about to start one-time replication",e),this.get_local_poll_db(e).replicate.from(this.remote_poll_dbs[e],{retry:!0,batch_size:1e3,include_docs:!0,selector:this.get_poll_doc_selector(e)}).on("change",u=>{this.G.L.trace("DataService.connect_to_remote_poll_db one-time replication received change",u),this.handle_poll_db_change.bind(this)(e,u,!1),0==u.pending&&(this.G.L.trace("DataService.connect_to_remote_poll_db completed one-time replication",e,this.poll_caches[e].state),this.need_poll_db_replication[e]=!1,"closed"==this.poll_caches[e].state?this.G.L.trace("DataService.connect_to_remote_poll_db no further syncing of closed poll",e):this.start_poll_sync.bind(this)(e),r(!0))}).on("error",function(u){this.G.L.warn("DataService.connect_to_remote_poll_db failed",e,u),o(u)}),this.G.L.trace("DataService.connect_to_remote_poll_db started one-time replication",e)}).catch(h=>{this.G.L.warn("DataService.connect_to_remote_poll_db failed",e,h),o(h)})}:(r,o)=>{this.get_remote_connection(this.getp(e,"db_server_url"),this.getp(e,"db_password"),i,this.G.S.password).then(h=>{this.remote_poll_dbs[e]=h,"closed"==this.poll_caches[e].state?this.G.L.trace("DataService.connect_to_remote_poll_db no more syncing of closed poll",e):this.start_poll_sync(e),r(!0)}).catch(h=>{this.G.L.warn("DataService.connect_to_remote_poll_db failed",e,h),o(h)})}),this.G.L.exit("DataService.connect_to_remote_poll_db",e),a}local_docs2cache_finished(){this.G.L.entry("DataService.local_user_docs2cache_finished"),this.after_changes(),this.G.L.info("DataService READY"),this._ready=!0,this.hide_loading(),this.page&&this.page.onDataReady&&this.page.onDataReady(),this.G.L.exit("DataService.local_user_docs2cache_finished")}wait_for_user_db(){return this.local_synced_user_db.info()}wait_for_poll_db(e){return e in this.local_poll_dbs?this.local_poll_dbs[e].info():new Promise((t,i)=>{t(!0)})}change_poll_state(e,t){this._pids.add(e.pid);const i=e.pid,a=_(i);this.G.L.entry("DataService.change_poll_state",i,t),"draft"==this.user_cache[a+"state"]&&(this.G.L.debug("DataService.change_poll_state old state was draft, so moving data from user db to poll db and then starting sync",i,t),this._setp_in_polldb(i,"due",e.due.toISOString()),this.wait_for_poll_db(i).finally(()=>{for(const[o,h]of Object.entries(this.user_cache))if(o.startsWith(a)){const u=o.substring(a.length),T=(u+".").indexOf("."),w=(u+".").slice(0,T);"state"!=u&&"due"!=u&&!S.includes(w)&&(this._setp_in_polldb(i,u,h)?this.delu(o):this.G.L.warn("DataService.change_poll_state couldn't move",i,o,u))}this.poll_has_db_credentials(i)?(this.G.L.trace("DataService.change_poll_state found remote poll db credentials"),this.connect_to_remote_poll_db(i).catch(o=>{this.G.L.warn("DataService.change_poll_state couldn't start remote poll db syncing for",i,o)})):this.G.L.warn("DataService.change_poll_state couldn't find remote poll db credential for",i)})),"draft"!=t&&"closing"!=t&&this._setp_in_polldb(i,"state",t),this.setu(a+"state",t),this.G.L.exit("DataService.change_poll_state")}replicate_once(e){return this.G.L.entry("DataService.replicate_once",e),new Promise((t,i)=>{this.get_local_poll_db(e).replicate.from(this.remote_poll_dbs[e],{retry:!0,batch_size:1e3,include_docs:!0,selector:this.get_poll_doc_selector(e)}).on("complete",a=>{this.G.L.trace("DataService.replicate_once completed",e,a),this.need_poll_db_replication[e]=!1,t(!0)}).on("change",a=>{this.G.L.trace("DataService.replicate_once received change",a),this.handle_poll_db_change.bind(this)(e,a,!1),0==a.pending&&(this.G.L.trace("DataService.replicate_once completed",e),this.need_poll_db_replication[e]=!1,t(!0))}).on("error",function(a){this.G.L.warn("DataService.replicate_once failed",e,a),i(a)}),this.G.L.trace("DataService.replicate_once started one-time replication",e)})}get_remote_poll_state_doc(e){return this.remote_poll_dbs[e].get(b+e+"\xa7state")}login_submitted(){this.G.L.entry("DataService.login_submitted"),this.show_loading(),""==(this.user_cache.db||"")&&(this.G.S.db="central"),this.G.add_spinning_reason("login");const e=this.G.S.language,t=this.G.S.email,i=this.G.S.password;this.G.S.language=this.G.S.email=this.G.S.password="",this.G.S.language=e,this.G.S.email=t,this.G.S.password=i,this.email_and_password_exist()}get_remote_connection(e,t,i,a){this.G.L.entry("DataService.get_remote_connection",e,t,i,a),this.show_loading();const r=new Promise((o,h)=>{const u=this.get_couchdb(e+"/_users","vodle",t);this.G.L.debug("DataService.get_remote_connection trying to get info for "+e+"/_users as user vodle"),u.info().then(T=>{this.G.L.debug("DataService logged into "+e+"/_users as user 'vodle'. Info:",T);const w=this.get_couchdb(e+"/vodle",i,a);this.G.L.debug("DataService.get_remote_connection trying to get info for "+e+"/vodle as actual user "+i),w.info().then(g=>{this.G.L.debug("DataService logged into "+e+" as actual user. Info:",g),this.test_remote_connection(w,i,a).then(L=>{o(w)}).catch(L=>{this.G.L.error("DataService.get_remote_connection could not write in database "+e+"/vodle as user "+i+". Please contact the database server admin!",L),h(["write failed",L])})}).catch(g=>{this.G.L.debug("DataService.get_remote_connection could not log into "+e+"/vodle as actual user:",g),this.G.L.info("DataService.get_remote_connection: logging in for the first time as this user? Trying to register user "+i+" in database."),u.put({_id:"org.couchdb.user:"+i,name:i,password:a,type:"user",roles:[],comment:"user generated by vodle"}).then(L=>{this.G.L.debug("DataService.get_remote_connection generated user "+i);const E=this.get_couchdb(e+"/vodle",i,a);this.G.L.debug("DataService.get_remote_connection trying to get info for "+e+"/vodle as actual user "+i),E.info().then(O=>{this.G.L.debug("DataService.get_remote_connection logged into "+e+" as new actual user "+i+". Info:",O),this.test_remote_connection(E,i,a).then(F=>{this.G.L.trace("DataService.get_remote_connection has write access as "+i+". All looks fine."),o(E)}).catch(F=>{this.G.L.error("DataService could not write in database "+e+"/vodle as new user "+i+". Please contact the database server admin!",F),h(["write failed",F])})}).catch(O=>{this.G.L.debug("DataService.get_remote_connection could not log into "+e+"/vodle as newly generated user:",O),h(["private login failed",O])})}).catch(L=>{this.G.L.error("DataService.get_remote_connection could not generate user "+i,L),h(["generate user failed",L])})})}).catch(T=>{this.G.L.error("DataService.get_remote_connection could not log into "+e+"/_users as user 'vodle':",T),h(["public login failed",T])})});return this.G.L.exit("DataService.get_remote_connection"),r}get_couchdb(e,t,i){return new s(e,{auth:{username:t,password:i},skipSetup:!0})}test_remote_connection(e,t,i){return new Promise((a,r)=>{a(!0)})}start_user_sync(){var e;if(this.G.L.entry("DataService.start_user_sync"),this.remote_user_db){const t=this.get_email_and_pw_hash();this.G.L.info("DataService starting user data sync"),this.user_db_sync_handler=this.local_synced_user_db.sync(this.remote_user_db,{live:!0,retry:!0,batch_size:1e3,style:"main_only",seq_interval:1e3,revs:!1,include_docs:!0,selector:this.get_user_doc_selector(t)}).on("change",this.handle_user_db_change.bind(this)).on("paused",()=>{this.G.L.info("DataService pausing user data sync")}).on("active",()=>{this.G.L.info("DataService resuming user data sync")}).on("denied",i=>{this.G.L.error("DataService user data sync denied",i)}).on("complete",i=>{this.G.L.info("DataService completed user data sync",i)}).on("error",i=>{this.G.L.error("DataService error at user data sync",i)}),e=!0}else e=!1;return this.G.L.exit("DataService.start_user_sync",e),e}start_poll_sync(e){var t;return this.G.L.entry("DataService.start_poll_sync",e),this.remote_poll_dbs[e]?(this.G.L.info("DataService starting poll data sync",e),this.poll_db_sync_handlers[e]=this.get_local_poll_db(e).sync(this.remote_poll_dbs[e],{live:!0,retry:!0,batch_size:1e3,include_docs:!0,selector:this.get_poll_doc_selector(e)}).on("change",i=>{this.handle_poll_db_change.bind(this)(e,i)}).on("paused",i=>{this.G.L.info("DataService pausing poll data sync",e,this.G.P.polls[e]._state),window,this.G.P.polls[e].syncing=!1,this.G.remove_spinning_reason(e)}).on("active",i=>{this.G.L.info("DataService resuming poll data syncing",e,i),window,this.G.P.polls[e].syncing=!0,this.G.add_spinning_reason(e)}).on("denied",i=>{this.G.L.error("DataService poll data sync denied",e,i)}).on("complete",i=>{this.G.L.info("DataService completed poll data sync",e,i),window,this.G.P.polls[e].syncing=!1}).on("error",i=>{this.G.L.error("DataService error at poll data sync",e,i)}),t=!0):t=!1,this.G.L.exit("DataService.start_poll_sync",e,t),t}stop_poll_sync(e){e in this.G.D.poll_db_sync_handlers&&this.G.D.poll_db_sync_handlers[e]&&this.G.D.poll_db_sync_handlers[e].cancel()}getu(e){let t=this.user_cache[e]||"";return!t&&"language"==e&&(t=this.getu("local_language")),t}setu(e,t){if(this.getu(e)==t)return!0;if(t=t||"","language"==e)this.setu("local_language",t);else if("local_language"==e){const a=""!=t?t:C.N.default_lang;this.translate.use(a),this.document.documentElement.lang=a}const i={};if(x.includes(e))for(const a of x)i[a]=this.user_cache[a];return this.user_cache[e]=t,this.G.L.trace("DataService.setu",e,t),x.includes(e)&&this.move_user_data(i),this.store_user_data(e,this.user_cache,e)}delu(e){e in this.user_cache?(delete this.user_cache[e],this.delete_user_data(e)):this.G.L.trace("DataService.delu cannot delete unknown key",e)}pid_is_draft(e){return"draft"==this.user_cache[_(e)+"state"]}getp(e,t){let i=null;const a=(t+".").indexOf("."),r=(t+".").slice(0,a);if(this.pid_is_draft(e)||S.includes(r)){const o=_(e)+t;i=this.user_cache[o]||""}else this.ensure_poll_cache(e),i=this.poll_caches[e][t]||"";return i}setp(e,t,i){if(this._pids.add(e),this.getp(e,t)==i)return!0;if(t.startsWith("option.")){this.G.L.trace("DataService.setp option key",e,t,i),e in this._pid_oids||(this._pid_oids[e]=new Set);const o=t.slice(7),h=o.slice(0,o.indexOf("."));this._pid_oids[e].add(h),this.G.L.trace("DataService.setp option pid oid",e,h,this._pid_oids[e].size,[...this._pid_oids[e]])}const a=(t+".").indexOf("."),r=(t+".").slice(0,a);if(this.pid_is_draft(e)||S.includes(r))return this._setp_in_userdb(e,t,i);if(t.startsWith("option.")){if(!(t in this.poll_caches[e]))return this._setp_in_polldb(e,t,i);this.G.L.error("DataService.setp change option attempted for existing entry",e,t,i)}else this.G.L.error("DataService.setp non-local attempted for non-draft poll",e,t,i)}delp(e,t){if("title"==t&&(this._pids.delete(e),delete this._pid_oids[e]),t.startsWith("option.")&&t.endsWith("name")&&e in this._pid_oids){this.G.L.trace("DataService.delp option key",e,t);const r=t.slice(7),o=r.slice(0,r.indexOf("."));this._pid_oids[e].delete(o),this.G.L.trace("DataService.delp option pid oid",e,o,this._pid_oids[e].size,[...this._pid_oids[e]])}const i=(t+".").indexOf("."),a=(t+".").slice(0,i);if(this.pid_is_draft(e)||S.includes(a)){const r=_(e)+t;this.delu(r)}else{if(!(e in this.poll_caches)||!(t in this.poll_caches[e]))return void this.G.L.trace("DataService.delp cannot delete unknown combination",e,t);delete this.poll_caches[e][t],this.delete_poll_data(e,t)}}getv(e,t,i){let a=null;if(this.pid_is_draft(e)){const r=_(e)+this.get_voter_key_prefix(e,i)+t;a=this.user_cache[r]||""}else{const r=this.get_voter_key_prefix(e,i)+t;this.ensure_poll_cache(e),a=this.poll_caches[e][r]||""}return a}setv(e,t,i){return this.getv(e,t)==i||(this.pid_is_draft(e)?this._setv_in_userdb(e,t,i):this.setv_in_polldb(e,t,i))}delv(e,t){if(this.pid_is_draft(e)){const i=_(e)+this.get_voter_key_prefix(e)+t;delete this.user_cache[i],this.delete_user_data(i)}else{const i=this.get_voter_key_prefix(e)+t;this.ensure_poll_cache(e),delete this.poll_caches[e][i],this.delete_poll_data(e,i)}}get_example_docs(){return this.remote_user_db.allDocs({include_docs:!0,startkey:"examples\xa7",endkey:"examplet",inclusive_end:!1,limit:50})}_setp_in_userdb(e,t,i){i=i||"";const a=_(e)+t;return this.G.L.trace("DataService._setp_in_userdb",e,t,i),this.user_cache[a]=i,this.store_user_data(a,this.user_cache,a)}_setp_in_polldb(e,t,i){i=i||"",this.ensure_poll_cache(e),this.G.L.trace("DataService._setp_in_polldb",e,t,i),this.poll_caches[e][t]=i;const a=t.slice(0,(t+".").indexOf("."));return this.store_poll_data(e,t,this.poll_caches[e],t,M.includes(a))}_setv_in_userdb(e,t,i){i=i||"";const a=_(e)+this.get_voter_key_prefix(e)+t;return this.G.L.trace("DataService._setv_in_userdb",e,t,i),this.user_cache[a]=i,this.store_user_data(a,this.user_cache,a)}setv_in_polldb(e,t,i,a){i=i||"";const r=this.get_voter_key_prefix(e,a)+t;this.ensure_poll_cache(e),this.G.L.trace("DataService.setv_in_polldb",e,t,i),this.poll_caches[e][r]=i;const o=t.slice(0,(t+".").indexOf("."));return this.store_poll_data(e,r,this.poll_caches[e],r,W.includes(o))}show_loading(){var e=this;return(0,I.Z)(function*(){e.G.L.entry("DataService.show_loading"),e._loading=!0,e.loadingElement=yield e.loadingController.create({spinner:"crescent"}),e._loading||e.hide_loading(),e.G.L.exit("DataService.show_loading")})()}hide_loading(){this.loadingElement&&this.loadingElement.dismiss(),this._loading=!1}fix_url(e){return e?e.startsWith("http://")||e.startsWith("https://")?e:"http://"+e:null}handle_user_db_change(e){this.G.L.entry("DataService.handle_user_db_change");let t=!1;if(e.deleted)t=this.handle_deleted_user_doc(e.doc);else if(!e.direction||"pull"==e.direction){e.change&&(e=e.change);for(const a of e.docs)if(a._deleted)t=this.handle_deleted_user_doc(a);else{var i;[t,i]=this.doc2user_cache(a)}e.last_seq&&(this.user_cache.user_last_seq=e.last_seq,this.G.L.trace("DataService.handle_user_db_change stored last_seq",e.last_seq))}t&&(this.after_changes(),this.page.onDataChange&&this.page.onDataChange()),this.G.L.exit("DataService.handle_user_db_change")}handle_poll_db_change(e,t,i=!0){this.G.L.entry("DataService.handle_poll_db_change",e,this.pending_changes,t);let a=!1;if(t.deleted)this.G.L.trace("DataService.handle_poll_db_change handling deleted"),a=this.handle_deleted_poll_doc(e,t.doc);else if(!t.direction||"pull"==t.direction){this.G.L.trace("DataService.handle_poll_db_change handling incoming"),t.change&&(t=t.change),this.G.L.trace("DataService.handle_poll_db_change n_docs, change:",t.docs.length,t);for(const r of t.docs)r._deleted?(this.G.L.trace("DataService.handle_poll_db_change doc was deleted",r),a=this.handle_deleted_poll_doc(e,r)):(this.G.L.trace("DataService.handle_poll_db_change doc was updated/new",r),this.pending_changes+=1,a=this.doc2poll_cache(e,r),this.pending_changes-=1);t.last_seq&&(this.poll_caches[e].last_seq=t.last_seq,this.G.L.trace("DataService.handle_poll_db_change stored last_seq",t.last_seq))}a&&(this.after_changes(i),this.page.onDataChange&&this.page.onDataChange()),this.G.L.exit("DataService.handle_poll_db_change",e,this.pending_changes)}handle_deleted_user_doc(e){const t=e._id;if(t.includes("\xa7")){const i=t.slice(t.indexOf("\xa7")+1);if(i in this.user_cache)return this.G.L.trace("DataService.handle_user_db_change deleting",i),delete this.user_cache[i],!0}return!1}handle_deleted_poll_doc(e,t){if(this.G.L.entry("DataService.handle_deleted_poll_doc",e,t),!(e in this.poll_caches))return!1;const i=t._id;if(i.includes(e)){const a=i.slice(i.indexOf(e)+e.length+1);if(a.includes(".del_request.")){const r=a.slice(6),o=r.slice(0,r.indexOf("\xa7")),u=r.slice(o.length+1).slice(12);this.G.Del.process_deleted_request_from_db(e,u,o)}else if(a.includes(".rating.")){const r=a.slice(6),o=r.slice(0,r.indexOf("\xa7")),u=r.slice(o.length+1).slice(7);this.G.P.update_own_rating(e,o,u,0,!1)}if(a in this.poll_caches[e])return this.G.L.trace("DataService.handle_poll_db_change deleting",a),delete this.poll_caches[e][a],!0}return!1}after_changes(e=!0){this.G.L.entry("DataService.after_changes");const t=this.getu("language"),i=""!=t?t:C.N.default_lang;this.translate.use(i),this.document.documentElement.lang=i;for(const a of new Set(this._pids)){this.G.L.info("DataService.after_changes processing poll",a);const r=this.G.D.getp(a,"due"),o=""==r?null:new Date(new Date(r).getTime()+24*C.N.polls.delete_after_days*60*60*1e3);if(o&&new Date>=o){this.G.L.debug("DataService.after_changes deleting old poll data",a,r),this.stop_poll_sync(a);const h=this.get_local_poll_db(a);h&&h.destroy(),delete this.local_poll_dbs[a],a in this.remote_poll_dbs&&delete this.remote_poll_dbs[a],a in this._pid_oids&&delete this._pid_oids[a];for(const u of S)this.delp(a,u);this._pids.delete(a)}else a in this.G.P.polls||(this.G.L.debug("DataService.after_changes creating poll object",a),new Z.n_(this.G,a)),!this.pid_is_draft(a)&&!(a in this.remote_poll_dbs)&&(this.poll_has_db_credentials(a)?(this.G.L.trace("DataService.after_changes found remote poll db credentials"),this.connect_to_remote_poll_db(a,this.need_poll_db_replication[a]||!1).catch(h=>{this.G.L.warn("DataService.after_changes couldn't start poll db syncing",a,h)})):this.G.L.warn("DataService.after_changes couldn't find remote poll db credentials",a))}for(const a in this._pid_oids){const r=this._pid_oids[a];for(const o of r)if(a in this.G.P.polls){const h=this.G.P.polls[a];h.oids.includes(o)||(this.G.L.trace("DataService.after_changes creating Option object",o),new Z.Wx(this.G,h,o))}else this.G.L.error("DataService.after_changes found an option for an unknown poll",a,o)}for(const[a,r]of Object.entries(this.G.P.polls))this.G.L.trace("DataService.after_changes telling poll to tally",a),r.ratings_have_changed=!0,r.after_incoming_changes(e);this.save_state(),this.G.L.exit("DataService.after_changes")}poll_has_db_credentials(e){return""!=this.getp(e,"db_server_url")&&""!=this.getp(e,"db_password")&&""!=this.getp(e,"myvid")}ensure_poll_cache(e){let t=this.poll_caches[e];return t||(t=this.poll_caches[e]={}),t}doc2user_cache(e){const t=e._id,i=y+this.get_email_and_pw_hash()+"\xa7";if(t.includes("\xa7timestamp")||"_design/vodle"===t)return[!1,!1];if(t.startsWith(i)){const a=t.slice(i.length,t.length);let r=!1,o=!1;const h=e.value;if(this.G.L.trace("DataService.doc2user_cache cyphertext is",h),h){const u=A.includes(a)?h:H(h,this.user_cache.password);this.user_cache[a]!=u&&(this.user_cache[a]=u,r=!0,a.startsWith("news.")?(this.G.L.trace("DataService.doc2user_cache news",a),this.news_keys.add(a)):a.startsWith("del_incoming.")&&(this.G.L.trace("DataService.doc2user_cache incoming did",a),this.incoming_dids_caches[a.slice(13)]=JSON.parse(u))),this.G.L.trace("DataService.doc2user_cache key, value",a,u),this.check_whether_poll_or_option(a,u)&&(o=!0)}else this.G.L.debug("DataService.doc2user_cache got corrupt doc",JSON.stringify(e));return[r,o]}return this.G.L.error("DataService.doc2user_cache got corrupt doc _id",t),[!1,!1]}check_whether_poll_or_option(e,t){let i=!1;if(e.startsWith("poll.")&&e.endsWith(".state")){const a=e.slice(5,e.indexOf(".state")),r=t;this._pids.has(a)||(this.G.L.trace("DataService.check_whether_poll_or_option found new poll",a),"draft"==r?this._pids.add(a):(this.ensure_local_poll_data(a),i=!0))}else if(e.startsWith("poll.")&&e.includes(".option.")&&e.endsWith(".name")){const a=e.slice(5,e.indexOf(".option.")),r=e.slice(e.indexOf(".option.")+8,e.indexOf(".name"));a in this._pid_oids||(this._pid_oids[a]=new Set),!this._pid_oids[a].has(r)&&(this.G.L.trace("DataService found new option",a,r),this._pid_oids[a].add(r),a in this.G.P.polls)&&new Z.Wx(this.G,this.G.P.polls[a],r)}return i}doc2poll_cache(e,t){this.G.L.entry("DataService.doc2poll_cache",e,t._id);const i=t._id;if(i.includes("\xa7timestamp")||"_design/vodle"===i)return!1;const a=b+e+"\xa7",r=b+e+".",o=this.ensure_poll_cache(e);var h,u;const T=t.due;if(T&&o.due&&T!=o.due)return this.G.L.warn("DataService.doc2poll_cache received doc with wrong due",t,this.poll_caches[e].due),!1;u=!1;const w=t.value;if(this.G.L.trace("DataService.doc2poll_cache cyphertext is",w),w){const g=i.endsWith("\xa7due")?w:H(w,this.user_cache[_(e)+"password"]);if(i.startsWith(a)){const L=(h=i.slice(a.length,i.length)).slice(0,(h+".").indexOf("."));if(M.includes(L)&&!T)return this.G.L.warn("DataService.doc2poll_cache received doc missing necessary due date",t),!1;if("state"==h&&(this.setu(_(e)+"state",g),e in this.G.P.polls&&(this.G.P.polls[e]._state=g)),h.startsWith("option.")&&h.endsWith(".name")){const E=h.slice(7),O=E.slice(0,E.indexOf("."));e in this._pid_oids||(this._pid_oids[e]=new Set),!this._pid_oids[e].has(O)&&(this.G.L.trace("DataService.doc2poll_cache found new option",e,O),this._pid_oids[e].add(O),e in this.G.P.polls)&&new Z.Wx(this.G,this.G.P.polls[e],O)}o[h]!=g&&(o[h]=g,u=!0)}else{if(!i.startsWith(r))return this.G.L.error("DataService.doc2poll_cache got corrupt doc _id",e,i),this.G.L.exit("DataService.doc2poll_cache false"),!1;{const L=(h=i.slice(r.length,i.length)).slice(6),E=L.slice(0,L.indexOf("\xa7")),O=L.slice(E.length+1),F=O.slice(0,(O+".").indexOf("."));if(W.includes(F)&&!T)return this.G.L.warn("DataService.doc2poll_cache received doc missing necessary due date",t),!1;if(this.G.L.trace("DataService.doc2poll_cache voter data item",e,E,O,g),o[h]!=g)if(o[h]=g,u=!0,O.startsWith("rating.")){const U=O.slice(7),ee=Number.parseInt(g);this.G.P.update_own_rating(e,E,U,ee,!1)}else if(O.startsWith("del_request.")){const U=O.slice(12);this.G.Del.process_request_from_db(e,U,E)}else if(O.startsWith("del_response.")){const U=O.slice(13);this.G.Del.process_signed_response_from_db(e,U,E)}}}this.G.L.trace("DataService.doc2poll_cache key, value",e,h,g)}else this.G.L.warn("DataService.doc2poll_cache got corrupt doc",e,JSON.stringify(t));return this.G.L.exit("DataService.doc2poll_cache value_changed",e,u),u}store_all_userdata(){for(const[e,t]of Object.entries(this.user_cache))this.store_user_data(e,this.user_cache,e)}store_all_polldata(e){for(const[t,i]of Object.entries(this.poll_caches[e]))this.store_poll_data(e,t,this.poll_caches[e],t)}store_user_data(e,t,i,a=!1){var r;if(this.G.L.trace("DataService.store_user_data",e,t[i]),!this.G.S.consent)return!1;if(D.includes(e))this.local_only_user_DB.get(e).then(o=>{const h=t[i];a||o.value!=h?(o.value=h,this.local_only_user_DB.put(o).then(()=>{this.G.L.trace("DataService.store_user_data local-only update",e,h)}).catch(u=>{this.G.L.warn("DataService.store_user_data couldn't local-only update, will try again soon",e,h,o,u),window.setTimeout(this.store_user_data.bind(this),C.N.db_put_retry_delay_ms,e,t,i,a=!0)})):this.G.L.trace("DataService.store_user_data local-only no need to update",e,h)}).catch(o=>{const h=t[i];this.local_only_user_DB.put(r={_id:e,value:h}).then(u=>{this.G.L.trace("DataService.store_user_data local-only new",e,h)}).catch(u=>{this.G.L.warn("DataService.store_user_data couldn't local-only new",e,h,r,u),this.local_only_user_DB.get(e).then(T=>{this.G.L.warn("DataService.store_user_data will try again soon",e,h,T,u),window.setTimeout(this.store_user_data.bind(this),C.N.db_put_retry_delay_ms,e,t,i,a=!0)})})});else{const o=this.get_email_and_pw_hash();if(!o)return this.G.L.warn("DataService.store_user_data couldn't set "+e+" since email or password are missing!"),!1;const h=y+o+"\xa7"+e,u=this.user_cache.password;this.local_synced_user_db.get(h).then(T=>{const w=t[i],g=A.includes(e)?w:J(w,u),L=A.includes(e)?T.value:H(T.value,u);L!=w?(T.value=g,this.local_synced_user_db.put(T).then(E=>{this.G.L.trace("DataService.store_user_data synced update",e,w)}).catch(E=>{this.G.L.warn("DataService.store_user_data couldn't synced update, will try again soon",e,w,E),window.setTimeout(this.store_user_data.bind(this),C.N.db_put_retry_delay_ms,e,t,i)})):this.G.L.trace("DataService.store_user_data synced no need to update",e,w,L)}).catch(T=>{const w=t[i],g=A.includes(e)?w:J(w,u);this.local_synced_user_db.put(r={_id:h,value:g}).then(L=>{this.G.L.trace("DataService.store_user_data synced new",e,w)}).catch(L=>{this.G.L.warn("DataService.store_user_data couldn't synced new, will try again soon",e,w,L),window.setTimeout(this.store_user_data.bind(this),C.N.db_put_retry_delay_ms,e,t,i)})})}return!0}store_poll_data(e,t,i,a,r=!1,o=!1){var h;if(this.G.L.trace("DataService.store_poll_data",e,t,i[a]),!this.G.S.consent)return!1;if(-1==t.indexOf("\xa7")){const u=b+e+"\xa7"+t,T=this.user_cache[_(e)+"password"];if(""==T||!T)return this.G.L.warn("DataService.store_poll_data couldn't set "+t+" in local_poll_DB since poll password is missing!"),!1;const w=this.get_local_poll_db(e);return w.get(u).then(g=>{const L=i[a],E=J(L,T);"due"!=t&&"state"!=t&&H(g.value,T)!=L?this.G.L.error("DataService.store_poll_data tried changing an existing poll data item",e,t,L):"due"==t&&g.due!=L&&this.G.L.error("DataService.store_poll_data tried changing due time",e,t,L),o||H(g.value,T)!=L?(g.value="due"==t?L:E,r&&(g.due=this.poll_caches[e].due),w.put(g).then(O=>{this.G.L.trace("DataService.store_poll_data update",e,t,L,g)}).catch(O=>{this.G.L.warn("DataService.store_poll_data couldn't update",e,t,L,g,O)})):this.G.L.trace("DataService.store_poll_data no need to update",e,t,L)}).catch(g=>{h={_id:u};const L=i[a],E=J(L,T);h.value="due"==t?L:E,r&&(h.due=this.poll_caches[e].due),w.put(h).then(O=>{this.G.L.trace("DataService.store_poll_data new",e,t,L,h)}).catch(O=>{this.G.L.warn("DataService.store_poll_data couldn't new",e,t,L,h,O),w.get(u).then(F=>{window.setTimeout(this.store_poll_data.bind(this),C.N.db_put_retry_delay_ms,e,t,i,a,r,!0),this.G.L.trace("DataService.store_poll_data scheduled new try",e,t,L,F,O)})})}),!0}{const u=t.slice(0,t.indexOf("\xa7")),T=this.user_cache[_(e)+"myvid"];if(u!="voter."+T&&"true"!=this.poll_caches[e].is_test)return this.G.L.error("DataService.store_poll_data tried changing another voter's data item",e,t),!1;const w=b+e+"."+t,g=this.user_cache[_(e)+"password"];if(""==g||!g||""==T||!T)return this.G.L.warn("DataService.store_poll_data couldn't set voter data "+t+" in local_poll_DB since poll password is missing!"),!1;const L=i[a],E=J(L,g),O=this.get_local_poll_db(e);return O.get(w).then(F=>{o||H(F.value,g)!=L?(F.value=E,r&&(F.due=this.poll_caches[e].due),O.put(F).then(U=>{this.G.L.trace("DataService.store_poll_data update",e,t,L)}).catch(U=>{this.G.L.warn("DataService.store_poll_data couldn't update voter doc, will try again soon",e,t,L,F,U),window.setTimeout(this.store_poll_data.bind(this),C.N.db_put_retry_delay_ms,e,t,i,a,r,!0)})):this.G.L.trace("DataService.store_poll_data no need to update",e,t,L)}).catch(F=>{const U=i[a],ee=J(U,g);h={_id:w,value:ee},r&&(h.due=this.poll_caches[e].due),O.put(h).then(te=>{this.G.L.trace("DataService.store_poll_data new",e,t,U)}).catch(te=>{this.G.L.warn("DataService.store_poll_data couldn't new",e,t,U,h,te),O.get(w).then(re=>{this.G.L.info("DataService.store_poll_data will try again soon",e,t,U,re,te),window.setTimeout(this.store_poll_data.bind(this),C.N.db_put_retry_delay_ms,e,t,i,a,r,!0)})})}),!0}}delete_user_data(e){var t,i;if(this.G.L.trace("DataService.delete_user_data",e),D.includes(e))t=this.local_only_user_DB,i=e;else{t=this.local_synced_user_db;const a=this.get_email_and_pw_hash();if(!a)return this.G.L.warn("DataService.delete_user_data couldn't delete "+e+" since email or password are missing!"),!1;i=y+a+"\xa7"+e}return t.get(i).then(a=>{t.remove(a).then(()=>{this.G.L.trace("DataService.delete_user_data delete",e)}).catch(r=>{this.G.L.warn("DataService.delete_user_data couldn't delete, will try again soon",e,a,r),window.setTimeout(this.delete_user_data.bind(this),C.N.db_put_retry_delay_ms,e)})}).catch(a=>{this.G.L.trace("DataService.delete_user_data no need to delete nonexistent key",e,a)}),!0}delete_poll_data(e,t){this.G.L.trace("DataService.delete_poll_data",e,t);const i=this.user_cache[_(e)+"password"];var a;if(-1==t.indexOf("\xa7")){if(a=b+e+"\xa7"+t,""==i||!i)return this.G.L.warn("DataService.delete_poll_data couldn't delete "+t+" from local_poll_DB since poll password or voter id are missing!"),!1}else{const o=t.slice(0,t.indexOf("\xa7")),h=this.user_cache[_(e)+"myvid"];if(o!="voter."+h)return this.G.L.error("DataService.delete_poll_data tried deleting another voter's data item",t),!1;if(a=b+e+"."+t,""==i||!i||""==h||!h)return this.G.L.warn("DataService.delete_poll_data couldn't delete "+t+" from local_poll_DB since poll password or voter id are missing!"),!1}const r=this.get_local_poll_db(e);return r.get(a).then(o=>{r.remove(o).then(()=>{this.G.L.trace("DataService.delete_poll_data local-only delete",e,t)}).catch(h=>{this.G.L.warn("DataService.delete_poll_data couldn't delete, will try again soon",e,t,o,h),window.setTimeout(this.delete_poll_data.bind(this),C.N.db_put_retry_delay_ms,e,t)})}).catch(o=>{this.G.L.warn("DataService.delete_poll_data no need to delete nonexistent key",e,t,o)}),!0}get_email_and_pw_hash(){const e=this.user_cache.email,t=this.user_cache.password;return""!=e&&e&&""!=t&&t?X(e+"\xa7"+t):null}move_user_data(e){this.G.L.entry("DataService.move_user_data")}clear_all_local(){return this.G.L.entry("DataService.clear_all_local"),this._ready=!1,new Promise((e,t)=>{this.G.L.info("Stopping database synchronisation..."),this.user_db_sync_handler&&this.user_db_sync_handler.cancel();for(const i in this.poll_db_sync_handlers)this.stop_poll_sync(i);this.G.L.info("Deleting local databases..."),this.local_synced_user_db.destroy().then(()=>{this.local_only_user_DB.destroy().then(()=>{for(let i in this.local_poll_dbs)this.local_poll_dbs[i]&&this.local_poll_dbs[i].destroy();this.G.L.info("Deleting local storage..."),this.storage?this.storage.clear().then(()=>{this.storage=null,this.G.L.info("...done!"),e(!0)}).catch(t):e(!0)}).catch(t)}).catch(t)})}delete_all(){return new Promise((e,t)=>{for(const[i,a]of Object.entries(this.G.D.incoming_dids_caches))if(a)for(const[r,[o,h,u]]of a)u[0].startsWith("declined")||(this.G.L.trace("DataService.delete_all declining request",r),this.G.Del.decline(i,r));for(const[i,a]of Object.entries(this.G.D.outgoing_dids_caches))if(a)for(const[r,o]of a)o&&(this.G.L.trace("DataService.delete_all revoking request",o),this.G.Del.revoke_delegation(i,o,r));for(const[i,a]of Object.entries(this.G.P.polls)){this.G.L.trace("DataService.delete_all setting zero waps for",i);for(const r of a.oids)a.set_my_own_rating(r,0,!0)}this.user_db_sync_handler&&this.user_db_sync_handler.cancel(),this.delete_remote().then(()=>{this.clear_all_local().catch(t)}).catch(t)})}delete_remote(){const e=this.get_email_and_pw_hash();return new Promise((t,i)=>{this.remote_user_db.allDocs({include_docs:!1,startkey:y+e+"\xa7",endkey:y+e+"\xa8",inclusive_end:!1}).then(a=>{const r=[];for(const o of a.rows)r.push({_id:o.id,_rev:o.value.rev,_deleted:!0});this.G.L.trace("DataService.delete_remote trying to delete",r),this.remote_user_db.bulkDocs(r).then(o=>{this.G.L.trace("DataService.delete_remote succeeded",o),t(!0)}).catch(o=>{this.G.L.error("DataService.delete_remote failed",o),i(o)})}).catch(i)})}init_notifications(e){var t=this;v.s.requestPermissions().then(function(){var i=(0,I.Z)(function*(a){const r=a.display;r.startsWith("prompt")&&e?yield(yield t.alertCtrl.create({header:t.translate.instant("data.notifications-permission-header"),message:t.translate.instant("data.notifications-permission-intro"),buttons:[{text:t.translate.instant("no"),role:"cancel",handler:()=>{t.G.L.trace("DataService.init_notifications user No")}},{text:t.translate.instant("yes"),role:"ok",handler:()=>{t.G.L.trace("DataService.init_notifications user Yes"),t.init_notifications(e=!1)}}]})).present():"granted"==r?(t.G.L.info("DataService.init_notifications granted"),t.can_notify=!0):(t.G.L.info("DataService.init_notifications denied:",a),t.can_notify=!1)});return function(a){return i.apply(this,arguments)}}()).catch(i=>{console.warn("DataService.init_notifications failed:",i)})}get_voter_key_prefix(e,t){return"voter."+(t||this.getp(e,"myvid"))+"\xa7"}format_date(e){return e?e.toLocaleDateString(this.translate.currentLang,{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric"}):""}hash(e){return X(e)}generate_id(e){return d.Z.lib.WordArray.random(e/2).toString()}email_is_valid(e){return!!String(e).toLowerCase().match(/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/)}test_sodium(){var e=this;return(0,I.Z)(function*(){e.G.L.entry("DataService.test_sodium waiting for sodium"),yield p.ready,e.G.L.trace("DataService.test_sodium ready");const i=e.generate_sign_keypair();e.G.L.trace("DataService.test_sodium keypair",i);const a=e.sign("This is just an example string.",i.private);e.G.L.trace("DataService.test_sodium signed",a);const r=e.open_signed(a,i.public);e.G.L.trace("DataService.test_sodium opened",r);const o=e.generate_sign_keypair(),h=e.open_signed(a,o.public);h?e.G.L.error("DataService.test_sodium should not have been able to open signed msg with wrong key!",i.public,o.public,h):e.G.L.trace("DataService.test_sodium correctly refused wrong key"),e.G.L.exit("DataService.test_sodium")})()}generate_sign_keypair(){try{const e=p.crypto_sign_keypair();return{public:p.to_hex(e.publicKey),private:p.to_hex(e.privateKey)}}catch{return}}sign(e,t){try{return p.to_hex(p.crypto_sign(e,p.from_hex(t)))}catch{return}}open_signed(e,t){try{return p.to_string(p.crypto_sign_open(p.from_hex(e),p.from_hex(t)))}catch{return}}str2rand(e){const t=e.length,i=t>=p.crypto_box_SEEDBYTES?e.slice(e.length-p.crypto_box_SEEDBYTES):"_".repeat(p.crypto_box_SEEDBYTES-t)+e,a=p.from_string(i),r=p.randombytes_buf_deterministic(4,a);return(((r[0]/256+r[1])/256+r[2])/256+r[3])/256}}return P.\u0275fac=function(e){return new(e||P)(N.LFG(G.F0),N.LFG(m.HT),N.LFG(m.Br),N.LFG(f.sK),N.LFG(Y.K),N.LFG(q.K0))},P.\u0275prov=N.Yz7({token:P,factory:P.\u0275fac,providedIn:"root"}),P})(),ie=(()=>{class P{constructor(){this.notification_classes=["delegation_accepted","delegation_declined","new_option","poll_closing_soon","poll_closed"],this.use_guest=!1,this.closing_soon_fraction=1/7,this.password_regexp="(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9]).*",this.language_names={de:"Deutsch",en:"English",es:"Espa\xf1ol",fr:"Fran\xe7ais",hi:"\u0939\u093f\u0928\u094d\u0926\u0940",ko:"\ud55c\uad6d\uc5b4",pl:"Polski",fi:"Suomi",zh:"\u4e2d\u6587",nn:"[show JSON file keys]"},this.validation_messages={email:[{type:"required",message:"validation.email-required"},{type:"email",message:"validation.email-valid"}],password:[{type:"required",message:"validation.password-required"},{type:"minlength",message:"validation.password-length"},{type:"pattern",message:"validation.password-pattern"}],passwords_match:[{message:"validation.passwords-match"}]}}init(e){this.G=e}get consent(){return"0"!=this.G.D.getu("consent")}set consent(e){this.G.D.setu("consent",e?"1":"0")}get email(){return this.G.D.getu("email")}set email(e){this.G.D.setu("email",e)}get password(){return this.G.D.getu("password")}set password(e){this.G.D.setu("password",e)}get db(){return this.G.D.getu("db")}set db(e){this.G.D.setu("db",e),this.compute_db_credentials()}get db_from_pid(){return this.G.D.getu("db_from_pid")}set db_from_pid(e){this.G.D.setu("db_from_pid",e),this.compute_db_credentials()}get db_custom_server_url(){return this.G.D.getu("db_custom_server_url")}set db_custom_server_url(e){this.G.D.setu("db_custom_server_url",e),this.compute_db_credentials()}get db_custom_password(){return this.G.D.getu("db_custom_password")}set db_custom_password(e){this.G.D.setu("db_custom_password",e),this.compute_db_credentials()}get db_server_url(){return this.G.D.getu("db_server_url")}set db_server_url(e){this.G.D.setu("db_server_url",e)}get db_password(){return this.G.D.getu("db_password")}set db_password(e){this.G.D.setu("db_password",e)}get language(){return this.G.D.getu("language")}set language(e){this.G.D.setu("language",e)}get theme(){return this.G.D.getu("theme")}set theme(e){this.G.D.setu("theme",e)}get default_wap(){return Number.parseInt(this.G.D.getu("default_wap")||"0")}set default_wap(e){this.G.D.setu("default_wap",e.toString())}get_notify_of(e){return"0"!=this.G.D.getu("notify_of_"+e)}set_notify_of(e,t){this.G.D.setu("notify_of_"+e,t?"1":"0")}passwords_match(e){if(e){const t=e.get("password"),i=e.get("confirm_password");if(t.errors)return t.errors;if(i.value!==t.value)return{must_match:!0}}return null}compute_db_credentials(){var e;"central"==this.db?(e=C.N.data_service.central_db_server_url,this.db_password=C.N.data_service.central_db_password):"poll"==this.db?(e=this.G.P.polls[this.db_from_pid].db_server_url,this.db_password=this.G.P.polls[this.db_from_pid].db_password):"other"==this.db&&(e=this.db_custom_server_url,this.db_password=this.db_custom_password),this.db_server_url=this.G.D.fix_url(e)}}return P.\u0275fac=function(e){return new(e||P)},P.\u0275prov=N.Yz7({token:P,factory:P.\u0275fac,providedIn:"root"}),P})(),ae=(()=>{class P{constructor(e){this.translate=e}init(e){e.L.entry("DelegationService.init"),this.G=e}generate_did(){return this.G.D.generate_id(C.N.data_service.did_length)}prepare_delegation(e){this.G.L.entry("DelegationService.prepare_delegation",e);const t=this.G.P.polls[e],i=this.generate_did(),a=this.G.D.generate_sign_keypair(),r={option_spec:{type:"-",oids:[]},public_key:a.public},o={client_vid:t.myvid,status:"pending",accepted_oids:new Set,active_oids:new Set};return this.G.L.exit("DelegationService.prepare_delegation"),[t,i,r,a.private,o]}get_delegation_link(e,t,i,a){const r=C.N.magic_link_base_url+"delrespond/"+e+"/"+t+"/"+encodeURIComponent(i)+"/"+a;return this.G.L.debug("DelegationService.get_delegation_link",r),r}after_request_was_sent(e,t,i,a,r){this.set_private_key(e,t,a),this.get_my_outgoing_dids_cache(e).set("*",t),this.set_my_request(e,t,i),this.get_delegation_agreements_cache(e).set(t,r),this.G.P.polls[e].have_acted=!0,this.G.D.save_state()}get_potential_effective_delegate(e,t){let i=this.get_my_outgoing_dids_cache(e).get(t);if(i||(i=this.get_my_outgoing_dids_cache(e).get("*")),!i)return null;const a=this.get_agreement(e,i);return a&&a.delegate_vid?a.delegate_vid:null}update_my_delegation(e,t,i){const a=this.G.P.polls[e];let r=this.get_my_outgoing_dids_cache(e).get(t);if(r||(r=this.get_my_outgoing_dids_cache(e).get("*")),r){this.G.L.trace("DelegationService.update_my_delegation",e,t,r);const o=this.get_delegation_agreements_cache(e).get(r);if(o.client_vid==a.myvid&&"agreed"==o.status&&o.accepted_oids.has(t))if(i){o.active_oids.has(t)&&this.G.L.warn("DelegationService.update_my_delegation oid already active",e,t,r);{o.accepted_oids.add(t);const h=this.get_request(e,r),u=h.option_spec;"+"==u.type?u.oids.includes(t)||u.oids.push(t):u.oids.splice(u.oids.indexOf(t),1),this.set_my_request(e,r,h)}}else if(o.active_oids.has(t)){o.accepted_oids.delete(t);const h=this.get_request(e,r),u=h.option_spec;"-"==u.type?u.oids.includes(t)||u.oids.push(t):u.oids.splice(u.oids.indexOf(t),1),this.set_my_request(e,r,h)}else this.G.L.warn("DelegationService.update_my_delegation oid not active",e,t,r);else this.G.L.error("DelegationService.update_my_delegation without agreed delegation from me",e,t,i,r)}else this.G.L.error("DelegationService.update_my_delegation without existing did",e,t,i)}revoke_delegation(e,t,i){this.G.L.entry("DelegationService.revoke_delegation",e,t);const a=this.get_delegation_agreements_cache(e).get(t),r=this.G.P.polls[e];if(a.client_vid!=r.myvid)this.G.L.error("DelegationService.revoke_delegation without request from me",e,t);else{this.G.D.delv(e,"del_request."+t);const h=this.get_delegation_agreements_cache(e);if(h){const u=h.get(t).active_oids;if(u)for(const T of u)r.del_delegation(r.myvid,T);h.delete(t)}}const o=this.get_my_outgoing_dids_cache(e);o&&o.delete(i)}get_incoming_request_status(e,t){if(e in this.G.P.polls){const a=this.G.P.polls[e];if("running"!=a.state)return["closed"];{const r=this.G.Del.get_delegation_agreements_cache(e).get(t);if(r){if("agreed"==r.status)return["accepted"];var i;const o=this.G.D.direct_delegation_map_caches[e],h=this.G.D.effective_delegation_map_caches[e],u=this.G.D.inv_effective_delegation_map_caches[e],T=a.myvid,w=r.client_vid;if(w==T)return["impossible","is-self"];let g=!1,L=!1,E=!1;for(let O of a.oids){const F=h.get(O).get(T)||T,U=u.get(O)||new Map;if(1+(U.get(w)||new Set([w])).size+(U.get(F)||new Set([F])).size>C.N.delegation.max_weight){E=!0;break}(o.get(O)||new Map).get(T)==w?g=!0:F==w&&(L=!0)}return i=E?["impossible","weight-exceeded"]:g?["possible","two-way"]:L?["possible","cycle"]:["possible","acyclic"],"declined"==r.status&&(i[0]="declined, "+i[0]),i}return["impossible","not-in-db"]}}return["impossible","poll-unknown"]}store_incoming_request(e,t,i,a,r){if("impossible"!=r){this.G.D.setu("del_incoming."+t,JSON.stringify([i,a,r]));let o=this.G.D.incoming_dids_caches[e];o||(o=this.G.D.incoming_dids_caches[e]=new Map),o.set(t,[i,a,r])}}update_incoming_request_status(e,t,i){const a=this.G.D.incoming_dids_caches[e],[r,o,h]=a.get(t);i!=h[0]&&this.store_incoming_request(e,t,r,o,i)}accept(e,t,i){const a={option_spec:{type:"-",oids:[]}},r=this.sign_response(a,i);this.G.L.info("DelegationService.accept",e,t,a),this.set_my_signed_response(e,t,r)}decline(e,t,i){i||(i=this.get_private_key(e,t));const a={option_spec:{type:"+",oids:[]}},r=this.sign_response(a,i);this.G.L.info("DelegationService.decline",e,t,a),this.set_my_signed_response(e,t,r)}get_delegate_nickname(e,t){return this.G.D.getp(e,"del_nickname."+t)}set_delegate_nickname(e,t,i){this.G.D.setp(e,"del_nickname."+t,i)}get_private_key(e,t){return this.G.D.getp(e,"del_private_key."+t)}set_private_key(e,t,i){this.G.D.setp(e,"del_private_key."+t,i)}get_request(e,t,i){i||(i=this.get_agreement(e,t).client_vid);const a=i?this.G.D.getv(e,"del_request."+t,i):null;return this.G.L.trace("DelegationService.get_request",e,t,i,a),a?JSON.parse(a):null}set_my_request(e,t,i){this.G.D.setv(e,"del_request."+t,JSON.stringify(i)),this.get_agreement(e,t).client_vid=this.G.P.polls[e].myvid,this.update_agreement(e,t,null,i,null)}get_signed_response(e,t,i){return this.G.L.entry("DelegationService.get_signed_response",e,t,i),i||(i=this.get_agreement(e,t).delegate_vid),i?this.G.D.getv(e,"del_response."+t,i):null}set_my_signed_response(e,t,i){this.G.D.setv(e,"del_response."+t,i);const a=this.get_agreement(e,t);a.delegate_vid=this.G.P.polls[e].myvid,this.update_agreement(e,t,a,null,i),this.update_incoming_request_status(e,t,a.status)}get_agreement(e,t){const i=this.get_delegation_agreements_cache(e);let a=i.get(t);return this.G.L.entry("DelegationService.get_agreement",e,t,a),a||(a={status:"pending",accepted_oids:new Set,active_oids:new Set},i.set(t,a)),a}process_request_from_db(e,t,i){const a=this.get_agreement(e,t);if(a.delegate_vid&&!a.client_vid){a.client_vid=i;const r=this.get_request(e,t,i),o=this.get_signed_response(e,t,i);this.response_signed_incorrectly(r,o)&&(this.G.L.warn("DelegationService.process_request_from_db: response was not properly signed",a),delete a.delegate_vid)}a.client_vid=i,this.update_agreement(e,t,a,null,null)}process_deleted_request_from_db(e,t,i){const a=this.get_delegation_agreements_cache(e).get(t),r=this.G.P.polls[e];if(a.client_vid!=i)this.G.L.error("DelegationService.process_deleted_request_from_db with wrong client_vid",e,t);else{const o=this.get_delegation_agreements_cache(e);if(o){const h=o.get(t).active_oids;if(h)for(const u of h)r.del_delegation(i,u);o.delete(t)}}}process_signed_response_from_db(e,t,i){this.G.L.entry("DelegationService.process_signed_response_from_db",e,t,i);const a=this.get_agreement(e,t),r=this.get_request(e,t,a.client_vid),o=this.get_signed_response(e,t,i);if(this.G.L.trace("DelegationService.process_signed_response_from_db",r,o),this.response_signed_incorrectly(r,o))return this.G.L.warn("DelegationService.process_signed_response_from_db: response was not properly signed",a),void(i==a.delegate_vid&&delete a.delegate_vid);a.delegate_vid=i,this.update_agreement(e,t,a,r,o)}update_agreement(e,t,i,a,r){this.G.L.entry("DelegationService.update_agreement",e,t,i,a,r);const o=i||this.get_agreement(e,t),h=this.G.P.polls[e];a||(a=this.get_request(e,t,o.client_vid)),r||(r=this.get_signed_response(e,t,o.delegate_vid));const u=o.status;if(this.G.L.entry("DelegationService.update_agreement",e,t,o,a,r,u),a&&r){o.accepted_oids||(o.accepted_oids=new Set);const T=JSON.parse(this.G.D.open_signed(r,a.public_key)),w={option_spec:{type:T[0],oids:T[1]}};if(w.option_spec){if("+"==w.option_spec.type){for(const g of o.accepted_oids)w.option_spec.oids.includes(g)||(o.accepted_oids.delete(g),this.G.L.trace("DelegationService.update_agreement revoked oid",e,g));for(const g of w.option_spec.oids)o.accepted_oids.has(g)||(o.accepted_oids.add(g),this.G.L.trace("DelegationService.update_agreement added oid",e,g))}else if("-"==w.option_spec.type){for(const g of o.accepted_oids)w.option_spec.oids.includes(g)&&(o.accepted_oids.delete(g),this.G.L.trace("DelegationService.update_agreement revoked oid",e,g));for(const g of h.oids)!o.accepted_oids.has(g)&&!w.option_spec.oids.includes(g)&&(o.accepted_oids.add(g),this.G.L.trace("DelegationService.update_agreement added oid",e,g))}o.status=o.accepted_oids.size>0?"agreed":"declined"}else o.status="declined";if(o.active_oids||(o.active_oids=new Set),a.option_spec){if("+"==a.option_spec.type){for(const g of o.active_oids)o.accepted_oids.has(g)&&a.option_spec.oids.includes(g)||(o.active_oids.delete(g),h.del_delegation(o.client_vid,g),this.G.L.trace("DelegationService.update_agreement deactivated oid",e,g));for(const g of a.option_spec.oids)o.accepted_oids.has(g)&&!o.active_oids.has(g)&&(h.add_delegation(o.client_vid,g,o.delegate_vid)?(o.active_oids.add(g),this.G.L.trace("DelegationService.update_agreement activated oid",e,g)):this.G.L.warn("DelegationService.update_agreement couldn't activate oid",e,g))}else if("-"==a.option_spec.type){for(const g of o.active_oids)(a.option_spec.oids.includes(g)||!o.accepted_oids.has(g))&&(o.active_oids.delete(g),h.del_delegation(o.client_vid,g),this.G.L.trace("DelegationService.update_agreement deactivated oid",e,g));for(const g of o.accepted_oids)!o.active_oids.has(g)&&!a.option_spec.oids.includes(g)&&(h.add_delegation(o.client_vid,g,o.delegate_vid)?(o.active_oids.add(g),this.G.L.trace("DelegationService.update_agreement activated oid",e,g)):this.G.L.warn("DelegationService.update_agreement couldn't activate oid",e,g))}o.status=o.accepted_oids.size>0?"agreed":"declined"}}else this.G.L.trace("DelegationService.update_agreement not complete yet",e),o.status="pending";o.client_vid==h.myvid&&("pending"==u&&"agreed"==o.status?this.G.N.add({class:"delegation_accepted",pid:e,auto_dismiss:!0,title:this.translate.instant("news-title.delegation_accepted",{nickname:this.get_delegate_nickname(e,t)})}):"declined"==u&&"agreed"==o.status?this.G.N.add({class:"delegation_accepted",pid:e,title:this.translate.instant("news-title.delegation_accepted_after_all",{nickname:this.get_delegate_nickname(e,t)})}):"pending"==u&&"declined"==o.status?this.G.N.add({class:"delegation_declined",pid:e,title:this.translate.instant("news-title.delegation_declined",{nickname:this.get_delegate_nickname(e,t)}),body:this.translate.instant("news-body.delegation_declined")}):"agreed"==u&&"declined"==o.status&&this.G.N.add({class:"delegation_declined",pid:e,title:this.translate.instant("news-title.delegation_revoked",{nickname:this.get_delegate_nickname(e,t)}),body:this.translate.instant("news-body.delegation_declined")})),this.G.L.exit("DelegationService.update_agreement",o.status,[...o.accepted_oids],[...o.active_oids])}response_signed_incorrectly(e,t){return this.G.L.entry("DelegationService.response_signed_incorrectly",e,t),!(!t||!e||this.G.D.open_signed(t,e.public_key))}sign_response(e,t){return this.G.D.sign(this.response2string(e),t)}response2string(e){return JSON.stringify([e.option_spec.type,e.option_spec.oids])}get_my_outgoing_dids_cache(e){return this.G.D.outgoing_dids_caches[e]||(this.G.D.outgoing_dids_caches[e]=new Map),this.G.D.outgoing_dids_caches[e]}get_delegation_agreements_cache(e){return this.G.D.delegation_agreements_caches[e]||(this.G.D.delegation_agreements_caches[e]=new Map),this.G.D.delegation_agreements_caches[e]}}return P.\u0275fac=function(e){return new(e||P)(N.LFG(f.sK))},P.\u0275prov=N.Yz7({token:P,factory:P.\u0275fac,providedIn:"root"}),P})(),ne=(()=>{class P{constructor(){}init(e){e.L.entry("NewsService.init"),this.G=e}generate_nid(){return this.G.D.generate_id(C.N.data_service.nid_length)}add(e){try{const t=e,i="news."+this.generate_nid();t.key=i,this.G.D.news_keys.add(i),this.G.D.setu(i,JSON.stringify(t)),this.G.L.trace("NewsService.add",i,t),this.G.S.get_notify_of(t.class)&&v.s.schedule({notifications:[{title:t.title,body:t.body,id:null}]}).then(a=>{this.G.L.trace("NewsService.add localNotifications.schedule succeeded:",a)}).catch(a=>{this.G.L.warn("NewsService.add localNotifications.schedule failed:",a)})}catch{this.G.L.warn("NewsService.add bad data:",e)}}dismiss(e){this.G.D.news_keys.has(e)?(this.G.L.entry("NewsService.dismiss",e),this.G.D.news_keys.delete(e)):this.G.L.warn("NewsService.dismiss unknown key",e),this.G.D.delu(e),this.G.D.save_state()}filter(e){this.G.L.entry("NewsService.filter",e);let t=new Set;for(let i of this.G.D.news_keys)try{const a=JSON.parse(this.G.D.getu(i));let r=!0;for(let[o,h]of Object.entries(e))if(a[o]!=h){r=!1;break}r&&t.add(a)}catch{}return t}}return P.\u0275fac=function(e){return new(e||P)},P.\u0275prov=N.Yz7({token:P,factory:P.\u0275fac,providedIn:"root"}),P})(),oe=(()=>{class P{constructor(e,t,i,a,r,o,h,u,T,w){this.http=t,this.storage=i,this.D=a,this.P=r,this.S=o,this.Del=h,this.N=u,this.translate=T,this.alertCtrl=w,this.show_spinner=!1,this._urlRegex=/^(?:http(s)?:\/\/)?[\w.-]+(?:\.[\w\.-]+)+[\w\-\._~:/?#[\]@!\$&'\(\)\*\+,;=.]+$/,this.urlRegex=/^(?:(http|ftp)(s)?:\/\/)?(?:(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?\.)+(?:[a-zA-Z]{2,6}\.?|[a-zA-Z0-9-]{2,}\.?)|localhost|\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}|\[?[a-fA-F0-9]*:[a-fA-F0-9:]+\]?)(?::\d+)?(?:\/?|[\/?]\S+)$/,this.spinning_reasons=new Set,this.L=e.getLogger("VODLE"),this.L.entry("GlobalService.constructor"),a.init(this),r.init(this),o.init(this),h.init(this),u.init(this),window.addEventListener("beforeunload",this.onBeforeUnload.bind(this)),window.onbeforeunload=this.onBeforeUnload.bind(this),window.onunhandledrejection=g=>{console.warn(`UNHANDLED PROMISE REJECTION: ${g.reason}`)},window.onerror=function(g,L,E,O,F){console.warn(`UNHANDLED ERROR: ${F.stack}`)},this.L.exit("GlobalService.constructor")}ngOnDestroy(){console.log("GlobalService.ngOnDestroy entry"),this.D.save_state(),console.log("GlobalService.ngOnDestroy exit")}onBeforeUnload(e){console.log("DATA onBeforeUnload entry"),this.storage&&(this.D.save_state(),this.D.page&&(this.D.page.ionViewWillLeave&&this.D.page.ionViewWillLeave(),this.D.page.ionViewDidLeave&&this.D.page.ionViewDidLeave(),this.D.page.ngOnDestroy&&this.D.page.ngOnDestroy())),console.log("DATA onBeforeUnload exit")}open_url_in_new_tab(e){var t=this;return(0,I.Z)(function*(){const i=t.D.fix_url(e);yield(yield t.alertCtrl.create({message:t.translate.instant("external-link.confirm",{url:i}),buttons:[{text:t.translate.instant("no"),role:"Cancel",handler:()=>{}},{text:t.translate.instant("external-link.copy-link"),handler:()=>{t.copy_link_to_clipboard(i)}},{text:t.translate.instant("external-link.yes"),role:"Ok",handler:()=>{const r=document.createElement("a");r.href=i,r.target="_blank",document.body.appendChild(r),r.click(),document.body.removeChild(r)}}]})).present()})()}copy_link_to_clipboard(e){window.navigator.clipboard.writeText(e),v.s.schedule({notifications:[{title:this.translate.instant("external-link.notification-copied-link-title"),body:this.translate.instant("external-link.notification-copied-link-body"),id:null}]}).then(t=>{}).catch(t=>{})}map2str(e){return e?JSON.stringify([...e.entries()].reduce((t,[i,a])=>(t[i]=a instanceof Set?[...a]:a instanceof Map?[...a.entries()]:a,t),{})):"#"}go_fullscreen_on_mobile(){if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){var e=document.documentElement;e.requestFullscreen&&e.requestFullscreen()}}add_spinning_reason(e){this.spinning_reasons.add(e),this.show_spinner=!0,this.L.trace("GlobalService.add_spinning_reason reasons",[...this.spinning_reasons.entries()])}remove_spinning_reason(e){this.spinning_reasons.has(e)&&(this.spinning_reasons.delete(e),0==this.spinning_reasons.size&&(this.show_spinner=!1)),this.L.trace("GlobalService.remove_spinning_reason reasons",[...this.spinning_reasons.entries()])}}return P.\u0275fac=function(e){return new(e||P)(N.LFG(z.ed),N.LFG(Q.eN),N.LFG(Y.K),N.LFG(se),N.LFG(Z.nr),N.LFG(ie),N.LFG(ae),N.LFG(ne),N.LFG(f.sK),N.LFG(m.Br))},P.\u0275prov=N.Yz7({token:P,factory:P.\u0275fac,providedIn:"root"}),P})()},8211:($,V,c)=>{"use strict";c.d(V,{Wx:()=>C,n_:()=>q,nr:()=>Y});var I=c(5568),v=c(2340),N=c(2135);let Y=(()=>{class Z{constructor(){this.polls={},this.unused_pids=[],this.unused_oids=[]}get running_polls(){const n={};for(const l in this.polls){const d=this.polls[l];"running"==d.state&&(n[d.pid]=d)}return n}get closed_polls(){const n={};for(const l in this.polls){const d=this.polls[l];"closed"==d.state&&(n[d.pid]=d)}return n}get draft_polls(){const n={};for(const l in this.polls){const d=this.polls[l];"draft"==d.state&&(n[d.pid]=d)}return n}init(n){n.L.entry("PollService.init"),this.G=n}generate_pid(){return this.unused_pids.pop()||this.G.D.generate_id(v.N.data_service.pid_length)}generate_oid(n){return n in this.unused_oids||(this.unused_oids[n]=[]),this.unused_oids[n].pop()||this.G.D.generate_id(v.N.data_service.oid_length)}generate_password(){return this.G.D.generate_id(v.N.data_service.pwd_length)}generate_vid(){return this.G.D.generate_id(v.N.data_service.vid_length)}update_ref_date(){this.ref_date=new Date}update_own_rating(n,l,d,p,G=!1){p>=0&&p<=100||(this.G.L.warn("PollService.update_own_rating replaced invalid rating by zero",p),p=0),this.G.L.trace("PollService.update_own_rating",n,l,d,p);let m=this.G.D.own_ratings_map_caches[n];m||(this.G.D.own_ratings_map_caches[n]=m=new Map);let f=m.get(d);f||(f=new Map,m.set(d,f)),p!=f.get(l)&&(n in this.polls?this.polls[n].update_own_rating(l,d,p,G):f.set(l,p))}}return Z.\u0275fac=function(n){return new(n||Z)},Z.\u0275prov=N.Yz7({token:Z,factory:Z.\u0275fac,providedIn:"root"}),Z})();class q{constructor(s,n){this.syncing=!1,this.allow_voting=!1,this._options={},this.ratings_have_changed=!1,this.G=s,n?this._state=this.G.D.getp(n,"state"):(n=this.G.P.generate_pid(),this.state="draft"),s.L.entry("Poll.constructor",n,this._state,this.G.D.getp(n,"state")),this._pid=n,this.G.P.polls[n]=this,this._pid in this.G.D.tally_caches?this.T=this.G.D.tally_caches[this._pid]:this._state in[null,"","draft"]||this.tally_all(),"running"==this._state?this.set_timeouts():"closed"==this._state&&!this.has_results&&this.end(),s.L.exit("Poll.constructor",n,this._state,this.G.D.getp(n,"state"))}set_timeouts(s){if(this.G.L.entry("Poll.set_timeouts",this._pid,s),!this.end_if_past_due()){this.allow_voting=!0,this.has_results=!1;const l=(new Date).getTime(),d=this.due;if(d){const p=d.getTime(),G=p-l;G<2e9?(window.setTimeout(this.end.bind(this),G),this.G.L.trace("Poll.set_timeouts: end scheduled",this._pid,G)):this.G.L.trace("Poll.set_timeouts: end not scheduled, too far in future",this._pid,G);const m=s||this.start_date;if(this.G.L.trace("Poll.set_timeouts start_date",this._pid,m),m){const f=m.getTime(),b=p-this.G.S.closing_soon_fraction*(p-f)-l;b>2e9?this.G.L.trace("Poll.set_timeouts: notify_closing_soon not scheduled, too far in future",this._pid,b):b>0?(window.setTimeout(this.notify_closing_soon.bind(this),b),this.G.L.trace("Poll.set_timeouts: notify_closing_soon scheduled",this._pid,b)):this.G.L.trace("Poll.set_timeouts: notify_closing_soon not scheduled since in past",this._pid,b)}}}}notify_closing_soon(){this.G.L.entry("Poll.notify_closing_soon",this._pid),this.G.S.get_notify_of("poll_closing_soon")&&I.s.schedule({notifications:[{title:this.G.translate.instant("notifications.closing-soon-title",{title:this.title}),body:this.G.translate.instant("notifications.closing-soon-body",{title:this.title,due:this.due_string}),id:null}]}).then(n=>{this.G.L.trace("Poll.notify_closing_soon localNotifications.schedule succeeded:",n)}).catch(n=>{this.G.L.warn("Poll.notify_closing_soon localNotifications.schedule failed:",n)})}delete(){this.G.L.entry("Poll.delete",this._pid),delete this.G.P.polls[this._pid],this.G.D.delp(this._pid,"type"),this.G.D.delp(this._pid,"title"),this.G.D.delp(this._pid,"desc"),this.G.D.delp(this._pid,"url"),this.G.D.delp(this._pid,"language"),this.G.D.delp(this._pid,"db"),this.G.D.delp(this._pid,"db_from_pid"),this.G.D.delp(this._pid,"db_custom_server_url"),this.G.D.delp(this._pid,"db_custom_password"),this.G.D.delp(this._pid,"db_server_url"),this.G.D.delp(this._pid,"db_password");for(const s of Object.keys(this._options))this._options[s].delete();this.G.D.delp(this._pid,"password"),this.G.D.delp(this._pid,"vid"),this.G.D.delp(this._pid,"state"),this.G.L.exit("Poll.delete",this._pid)}get pid(){return this._pid}get creator(){return this.G.D.getp(this._pid,"creator")}set creator(s){this.G.D.setp(this._pid,"creator",s)}get have_seen(){return"true"==this.G.D.getp(this._pid,"have_seen")}set have_seen(s){this.G.D.setp(this._pid,"have_seen",s.toString())}get has_results(){return"true"==this.G.D.getp(this._pid,"has_results")}set has_results(s){this.G.D.setp(this._pid,"has_results",s.toString())}get have_seen_results(){return"true"==this.G.D.getp(this._pid,"have_seen_results")}set have_seen_results(s){this.G.D.setp(this._pid,"have_seen_results",s.toString())}get have_acted(){return"true"==this.G.D.getp(this._pid,"have_acted")}set have_acted(s){this.G.D.setp(this._pid,"have_acted",s.toString())}get has_been_notified_of_end(){return"true"==this.G.D.getp(this._pid,"has_been_notified_of_end")}set has_been_notified_of_end(s){this.G.D.setp(this._pid,"has_been_notified_of_end",s.toString())}get db(){return this.G.D.getp(this._pid,"db")}set db(s){"draft"==this.state&&this.G.D.setp(this._pid,"db",s)}get db_from_pid(){return this.G.D.getp(this._pid,"db_from_pid")}set db_from_pid(s){"draft"==this.state&&this.G.D.setp(this._pid,"db_from_pid",s)}get db_custom_server_url(){return this.G.D.getp(this._pid,"db_custom_server_url")}set db_custom_server_url(s){"draft"==this.state&&this.G.D.setp(this._pid,"db_custom_server_url",s)}get db_custom_password(){return this.G.D.getp(this._pid,"db_custom_password")}set db_custom_password(s){"draft"==this.state&&this.G.D.setp(this._pid,"db_custom_password",s)}get db_server_url(){return this.G.D.getp(this._pid,"db_server_url")}set db_server_url(s){this.G.D.setp(this._pid,"db_server_url",s)}get db_password(){return this.G.D.getp(this._pid,"db_password")}set db_password(s){this.G.D.setp(this._pid,"db_password",s)}get password(){return this.G.D.getp(this._pid,"password")}set password(s){this.G.D.setp(this._pid,"password",s)}get myvid(){return this.G.D.getp(this._pid,"myvid")}set myvid(s){this.G.D.setp(this._pid,"myvid",s)}get final_rand(){return Number.parseFloat(this.G.D.getp(this._pid,"final_rand"))}set final_rand(s){this.G.D.setp(this._pid,"final_rand",s.toString())}get winner(){return this.G.D.getp(this._pid,"winner")}set winner(s){this.G.D.setp(this._pid,"winner",s)}get state(){return this._state}set state(s){const n=this.state;n!=s&&({null:["draft"],"":["draft"],draft:["running"],running:["closed"]}[n].includes(s)?(this.G.D.change_poll_state(this,s),this._state=s,"running"==s&&this.set_timeouts(new Date)):this.G.L.error("Poll invalid state transition from "+n+" to "+s))}get is_test(){return"true"==this.G.D.getp(this._pid,"is_test")}set is_test(s){this.G.D.setp(this._pid,"is_test",s.toString())}get type(){return this.G.D.getp(this._pid,"type")}set type(s){this.G.D.setp(this._pid,"type",s)}get language(){return this.G.D.getp(this._pid,"language")}set language(s){this.G.D.setp(this._pid,"language",s)}get title(){return this.G.D.getp(this._pid,"title")}set title(s){this.G.D.setp(this._pid,"title",s)}get desc(){return this.G.D.getp(this._pid,"desc")}set desc(s){this.G.D.setp(this._pid,"desc",s)}get url(){return this.G.D.getp(this._pid,"url")}set url(s){this.G.D.setp(this._pid,"url",s)}get due_type(){return this.G.D.getp(this._pid,"due_type")}set due_type(s){this.G.D.setp(this._pid,"due_type",s)}get start_date(){const s=this.G.D.getp(this._pid,"start_date");return""==s?null:new Date(s)}set start_date(s){this.G.D.setp(this._pid,"start_date",""!=(s||"")&&s.getTime()==s.getTime()?s.toISOString():"")}get due_custom(){const s=this.G.D.getp(this._pid,"due_custom");return""==s?null:new Date(s)}set due_custom(s){this.G.D.setp(this._pid,"due_custom",""!=(s||"")&&s.getTime()==s.getTime()?s.toISOString():"")}get due(){const s=this.G.D.getp(this._pid,"due");return""==s?null:new Date(s)}set due(s){this.G.D.setp(this._pid,"due",""!=(s||"")&&s.getTime()==s.getTime()?s.toISOString():"")}get due_string(){return this.G.D.format_date(this.due)}_add_option(s){return!(s.oid in this._options)&&(this._options[s.oid]=s,this.own_ratings_map.has(s.oid)||this.own_ratings_map.set(s.oid,new Map),this.proxy_ratings_map.has(s.oid)||this.proxy_ratings_map.set(s.oid,new Map),this.direct_delegation_map.has(s.oid)||this.direct_delegation_map.set(s.oid,new Map),this.inv_direct_delegation_map.has(s.oid)||this.inv_direct_delegation_map.set(s.oid,new Map),this.indirect_delegation_map.has(s.oid)||this.indirect_delegation_map.set(s.oid,new Map),this.inv_indirect_delegation_map.has(s.oid)||this.inv_indirect_delegation_map.set(s.oid,new Map),this.effective_delegation_map.has(s.oid)||this.effective_delegation_map.set(s.oid,new Map),this.inv_effective_delegation_map.has(s.oid)||this.inv_effective_delegation_map.set(s.oid,new Map),!0)}get options(){return this._options}remove_option(s){return s in this._options&&(delete this._options[s],!0)}get oids(){return Object.keys(this._options)}get n_options(){return this.oids.length}get_my_own_rating(s){this.own_ratings_map.has(s)||this.own_ratings_map.set(s,new Map);const n=this.own_ratings_map.get(s);return n.has(this.myvid)||n.set(this.myvid,0),n.get(this.myvid)}set_my_own_rating(s,n,l=!0){l&&this.G.D.setv(this._pid,"rating."+s,n.toString()),this.update_own_rating(this.myvid,s,n,!0)}get_my_proxy_rating(s){return(this.proxy_ratings_map.get(s)||new Map).get(this.myvid)||0}get_my_effective_rating(s){return(this.effective_ratings_map.get(s)||new Map).get(this.myvid)||0}get remaining_time_fraction(){if("running"==this._state&&this.start_date&&this.due){const s=this.start_date.getTime(),n=(new Date).getTime(),l=this.due.getTime();return(l-n)/(l-s)}return null}get is_closing_soon(){return!("running"!=this._state||!this.start_date||!this.due)&&this.remaining_time_fraction<this.G.S.closing_soon_fraction}get am_abstaining(){return!!this.T.votes_map&&void 0===this.T.votes_map.get(this.myvid)}get my_n_rated_positive(){let s=0;for(const n of this.oids)this.get_my_proxy_rating(n)>0&&s++;return s}get my_n_approved(){let s=0;for(const n of this.oids)this.T.approvals_map.get(n)&&this.T.approvals_map.get(n).get(this.myvid)&&s++;return s}get have_delegated(){const s=this.G.Del.get_my_outgoing_dids_cache(this.pid).get("*");if(!s)return!1;const n=this.G.Del.get_agreement(this.pid,s);return"agreed"==n.status&&n.active_oids.size==n.accepted_oids.size}set_db_credentials(){"central"==this.db?(this.db_server_url=v.N.data_service.central_db_server_url,this.db_password=v.N.data_service.central_db_password):"poll"==this.db?(this.db_server_url=this.G.P.polls[this.db_from_pid].db_server_url,this.db_password=this.G.P.polls[this.db_from_pid].db_password):"other"==this.db?(this.db_server_url=this.db_custom_server_url,this.db_password=this.db_custom_password):"default"==this.db&&(this.db_server_url=this.G.S.db_server_url,this.db_password=this.G.S.db_password),this.db_server_url=this.G.D.fix_url(this.db_server_url)}set_due(){if("custom"==this.due_type)this.due=this.due_custom;else{var s=new Date;s.setSeconds(0,0);const n=s.getDay(),l=s.getHours(),d=s.getTime();"midnight"==this.due_type?s.setHours(23,59,59,999):"10min"==this.due_type?s=new Date(d+6e5):"hour"==this.due_type?s=new Date(d+36e5):"24hr"==this.due_type?s=new Date(d+864e5):"tomorrow-noon"==this.due_type?(s=new Date(d+864e5)).setHours(12,0,0,0):"tomorrow-night"==this.due_type?(s=new Date(d+864e5)).setHours(23,59,59,999):"friday-noon"==this.due_type?(s=l<12||5!=n?new Date(d+(5-n)%7*24*60*60*1e3):new Date(d+6048e5)).setHours(12,0,0,0):"sunday-night"==this.due_type?(s=new Date(d+(7-n)%7*24*60*60*1e3)).setHours(23,59,59,999):"week"==this.due_type?(s=new Date(d+6048e5)).setHours(23,59,59,999):"two-weeks"==this.due_type?(s=new Date(d+12096e5)).setHours(23,59,59,999):"four-weeks"==this.due_type&&(s=new Date(d+24192e5)).setHours(23,59,59,999),this.due=s}this.G.L.info("PollService.set_due",s)}init_password(){""==(this.password||"")?(this.password=this.G.P.generate_password(),this.G.L.info("PollService.init_password",this.password)):this.G.L.error("Attempted to init_password() when password already existed.")}init_myvid(){this.myvid=this.G.P.generate_vid(),this.G.L.info("PollService.init_vid",this.myvid)}after_incoming_changes(s=!0){"running"==this.state&&this.ratings_have_changed&&(this.ratings_have_changed=!1,s&&this.tally_all())}get own_ratings_map(){if(!this._own_ratings_map)if(this._pid in this.G.D.own_ratings_map_caches)this._own_ratings_map=this.G.D.own_ratings_map_caches[this._pid];else{this.G.D.own_ratings_map_caches[this._pid]=this._own_ratings_map=new Map;for(const s of this.oids)this._own_ratings_map.set(s,new Map)}return this._own_ratings_map}get direct_delegation_map(){if(!this._direct_delegation_map)if(this._pid in this.G.D.direct_delegation_map_caches)this._direct_delegation_map=this.G.D.direct_delegation_map_caches[this._pid];else{this.G.D.direct_delegation_map_caches[this._pid]=this._direct_delegation_map=new Map;for(const s of this.oids)this._direct_delegation_map.set(s,new Map)}return this._direct_delegation_map}get inv_direct_delegation_map(){if(!this._inv_direct_delegation_map)if(this._pid in this.G.D.inv_direct_delegation_map_caches)this._inv_direct_delegation_map=this.G.D.inv_direct_delegation_map_caches[this._pid];else{this.G.D.inv_direct_delegation_map_caches[this._pid]=this._inv_direct_delegation_map=new Map;for(const s of this.oids)this._inv_direct_delegation_map.set(s,new Map)}return this._inv_direct_delegation_map}get indirect_delegation_map(){if(!this._indirect_delegation_map)if(this._pid in this.G.D.indirect_delegation_map_caches)this._indirect_delegation_map=this.G.D.indirect_delegation_map_caches[this._pid];else{this.G.D.indirect_delegation_map_caches[this._pid]=this._indirect_delegation_map=new Map;for(const s of this.oids)this._indirect_delegation_map.set(s,new Map)}return this._indirect_delegation_map}get inv_indirect_delegation_map(){if(!this._inv_indirect_delegation_map)if(this._pid in this.G.D.inv_indirect_delegation_map_caches)this._inv_indirect_delegation_map=this.G.D.inv_indirect_delegation_map_caches[this._pid];else{this.G.D.inv_indirect_delegation_map_caches[this._pid]=this._inv_indirect_delegation_map=new Map;for(const s of this.oids)this._inv_indirect_delegation_map.set(s,new Map)}return this._inv_indirect_delegation_map}get effective_delegation_map(){if(!this._effective_delegation_map)if(this._pid in this.G.D.effective_delegation_map_caches)this._effective_delegation_map=this.G.D.effective_delegation_map_caches[this._pid];else{this.G.D.effective_delegation_map_caches[this._pid]=this._effective_delegation_map=new Map;for(const s of this.oids)this._effective_delegation_map.set(s,new Map)}return this._effective_delegation_map}get inv_effective_delegation_map(){if(!this._inv_effective_delegation_map)if(this._pid in this.G.D.inv_effective_delegation_map_caches)this._inv_effective_delegation_map=this.G.D.inv_effective_delegation_map_caches[this._pid];else{this.G.D.inv_effective_delegation_map_caches[this._pid]=this._inv_effective_delegation_map=new Map;for(const s of this.oids)this._inv_effective_delegation_map.set(s,new Map)}return this._inv_effective_delegation_map}get proxy_ratings_map(){if(!this._proxy_ratings_map)if(this._pid in this.G.D.proxy_ratings_map_caches)this._proxy_ratings_map=this.G.D.proxy_ratings_map_caches[this._pid];else{this.G.D.proxy_ratings_map_caches[this._pid]=this._proxy_ratings_map=new Map;for(const s of this.oids)this._proxy_ratings_map.set(s,new Map)}return this._proxy_ratings_map}get max_proxy_ratings_map(){return this._max_proxy_ratings_map||(this._pid in this.G.D.max_proxy_ratings_map_caches?this._max_proxy_ratings_map=this.G.D.max_proxy_ratings_map_caches[this._pid]:this.G.D.max_proxy_ratings_map_caches[this._pid]=this._max_proxy_ratings_map=new Map),this._max_proxy_ratings_map}get argmax_proxy_ratings_map(){return this._argmax_proxy_ratings_map||(this._pid in this.G.D.argmax_proxy_ratings_map_caches?this._argmax_proxy_ratings_map=this.G.D.argmax_proxy_ratings_map_caches[this._pid]:this.G.D.argmax_proxy_ratings_map_caches[this._pid]=this._argmax_proxy_ratings_map=new Map),this._argmax_proxy_ratings_map}get effective_ratings_map(){if(!this._effective_ratings_map)if(this._pid in this.G.D.effective_ratings_map_caches)this._effective_ratings_map=this.G.D.effective_ratings_map_caches[this._pid];else{this.G.D.effective_ratings_map_caches[this._pid]=this._effective_ratings_map=new Map;for(const s of this.oids)this._effective_ratings_map.set(s,new Map)}return this._effective_ratings_map}get agreement_level(){const s=this.T.approval_scores_map,n=this.T.n_not_abstaining;let l=0;for(const[d,p]of this.T.shares_map.entries())l+=p*s.get(d);return l/Math.max(1,n)}add_delegation(s,n,l){if(!v.N.delegation.enabled)return this.G.L.error("PollService.add_delegation when delegation is disabled",this._pid,s,n,l),!1;this.G.L.debug("add_delegation entry",this.pid,n,s,l);const d=this.direct_delegation_map.get(n),p=this.effective_delegation_map.get(n),G=p.get(l)||l;if(d.has(s))return d.get(s)==l?(this.G.L.warn("PollService.add_delegation of existing delegation",this._pid,s,n,l,d.get(s)),!0):(this.G.L.error("PollService.add_delegation when delegation already exists",this._pid,s,n,l,d.get(s)),!1);{this.G.L.trace("PollService.add_delegation feasible",this._pid,s,n,l),d.set(s,l);const m=this.inv_direct_delegation_map.get(n);m.has(l)||m.set(l,new Set),m.get(l).add(s);const f=this.indirect_delegation_map.get(n),j=f.get(l),y=this.inv_indirect_delegation_map.get(n),b=this.inv_effective_delegation_map.get(n);y.has(l)||y.set(l,new Set);const _=y.get(l),D=b.get(s),x=new Set([l]);if(f.set(s,x),_.add(s),j)for(const S of j)S!=s&&(x.add(S),y.has(S)||y.set(S,new Set),y.get(S).add(s));if(D)for(const S of D){const A=f.get(S);if(S!=l&&(A.add(l),_.add(S)),j)for(const M of j)M!=S&&(A.add(M),y.has(M)||y.set(M,new Set),y.get(M).add(S))}if(G==s){let A=l,M=this.own_ratings_map.get(n).get(A)||0,W=0,R=!1;for(W=1;W<=this.T.all_vids_set.size&&(A=d.get(A),A!=l);W++)M=Math.max(M,this.own_ratings_map.get(n).get(A)||0),A==this.myvid&&(R=!0);if(this.G.L.info("add_delegation created cycle of length",W,R,this.pid,n,s,l),R&&(this.T.my_cycle_len=W),this.update_proxy_rating(s,n,M),D)for(const K of D)this.update_proxy_rating(K,n,M)}else{const S=this.own_ratings_map.get(n).get(G)||0;b.has(G)||b.set(G,new Set);const A=b.get(G);if(p.set(s,G),A.add(s),this.update_proxy_rating(s,n,S),D)for(const M of D)p.set(M,G),A.add(M),this.update_proxy_rating(M,n,S)}return this.G.L.debug("add_delegation exit",this.pid,n,s,l),!0}}del_delegation(s,n){const l=this.direct_delegation_map.get(n),d=this.effective_delegation_map.get(n);if(l.has(s)){const p=l.get(s),G=d.get(s),m=this.inv_direct_delegation_map.get(n),f=this.indirect_delegation_map.get(n),j=f.get(s),y=this.inv_indirect_delegation_map.get(n),b=y.get(s),_=this.inv_effective_delegation_map.get(n),D=_.get(s),x=_.get(G),S=f.get(p).has(s);this.G.L.debug("del_delegation entry",this.pid,n,s,p,S),l.delete(s),m.get(p).delete(s);for(const M of j)y.get(M).delete(s);if(f.delete(s),S){let M=p,W=[M];for(;M=l.get(M),W.push(M),M!=s;);if(W.includes(this.myvid)&&(this.T.my_cycle_len=null),b)for(const R of b){let K=R,J=-1;for(;J=W.indexOf(K),-1==J;)K=l.get(K);const H=f.get(R);for(let X=0;X<J;X++){const k=W[X];H.has(k)&&(H.delete(k),y.get(k).delete(R))}}}else if(b)for(const M of b){const W=f.get(M);for(const R of j)W.delete(R),y.get(R).delete(M)}const A=this.own_ratings_map.get(n).get(s)||0;if(d.delete(s),x.delete(s),this.update_proxy_rating(s,n,A),b)for(const M of b)x.delete(M),d.set(M,s),D.add(M),this.update_proxy_rating(M,n,A);this.G.L.debug("del_delegation exit",this.pid,n,s,p,S)}else this.G.L.error("PollService.del_delegation when no delegation exists",s,n)}get_n_indirect_option_clients(s,n){return(this.inv_indirect_delegation_map.get(n).get(s)||new Set).size}get_n_indirect_clients(s){let n=new Set;for(const l of this.oids)for(const d of this.inv_indirect_delegation_map.get(l).get(s)||new Set)n.add(d);return n.size}tally_all(){this.G.L.entry("Poll.tally_all",this._pid),this.G.D.tally_caches[this._pid]=this.T={all_vids_set:new Set,n_not_abstaining:0,effective_ratings_ascending_map:new Map,thresholds_map:new Map,approvals_map:new Map,approval_scores_map:new Map,total_effective_ratings_map:new Map,scores_map:new Map,oids_descending:[],votes_map:new Map,n_votes_map:new Map,shares_map:new Map,my_cycle_len:null};for(const[l,d]of this.effective_ratings_map){let p=0;for(const[G,m]of d)this.T.all_vids_set.add(G),p+=m;this.T.total_effective_ratings_map.set(l,p)}this.T.n_not_abstaining=0;for(const l of this.T.all_vids_set)this.max_proxy_ratings_map.get(l)&&(this.T.n_not_abstaining+=1);const s=128*this.T.n_not_abstaining;for(const l of this.oids){const d=this.effective_ratings_map.get(l);if(d){const p=this.update_ratings_ascending(l,d);this.update_threshold_and_approvals(l,d,p);const[G,m]=this.update_approval_score(l,this.T.approvals_map.get(l)||new Map);this.update_score(l,G,this.T.total_effective_ratings_map.get(l)||0,s)}else this.T.effective_ratings_ascending_map.set(l,[]),this.T.thresholds_map.set(l,100),this.T.approvals_map.set(l,new Map),this.T.approval_scores_map.set(l,0),this.T.total_effective_ratings_map.set(l,0),this.update_score(l,0,0,s)}this.update_ordering();const n=this.T.oids_descending;for(const l of this.T.all_vids_set)this.update_vote(l,n);this.update_shares(n)&&(this.G.L.trace("Poll.tally_all pie charts need updating"),!!this.G.D.page&&"function"==typeof this.G.D.page.show_stats&&this.G.D.page.show_stats()),this.G.L.exit("Poll.tally_all",this._pid)}update_own_rating(s,n,l,d=!1){this.G.L.trace("Poll.update_own_rating",this.pid,s,n,l),this.own_ratings_map.has(n)||(this.own_ratings_map.set(n,new Map),this.G.L.trace("Poll.update_own_rating first own rating for option",n));const p=this.own_ratings_map.get(n),G=p.get(s)||0;if(this.G.L.trace("Poll.update_own_rating old rating:",this.pid,s,n,G),l!=G&&(this.ratings_have_changed=!0,p.set(s,l),this.G.L.trace("Poll.update_own_rating new ratings map",this.pid,n,[...p.entries()]),this.direct_delegation_map.get(n)||this.direct_delegation_map.set(n,new Map),!this.direct_delegation_map.get(n).has(s))){this.G.L.trace("Poll.update_own_rating voter has not delegated",this.pid,s,n),this.update_proxy_rating(s,n,l,d);const m=(this.inv_effective_delegation_map.get(n)||new Map).get(s);if(m)for(const f of m)this.update_proxy_rating(f,n,l,d)}}update_proxy_rating(s,n,l,d=!1){this.G.L.entry("Poll.update_proxy_rating",this.pid,s,n,l),this.T.all_vids_set.has(s)||(this.T.all_vids_set.add(s),this.G.L.trace("Poll.update_proxy_rating n_changed, first proxy rating of voter",s)),this.proxy_ratings_map.has(n)||(this.proxy_ratings_map.set(n,new Map),this.G.L.trace("Poll.update_proxy_rating first proxy rating for option",n));const p=this.proxy_ratings_map.get(n),G=p.get(s)||0;if(l!=G){this.G.L.trace("Poll.update_proxy_rating proxy rating of",n,"by",s,"changed from",G,"to",l),0!=l?p.set(s,l):p.delete(s);let j=!1;const y=this.max_proxy_ratings_map.get(s)||0,b=this.argmax_proxy_ratings_map.get(s)||new Set,_=new Map;this.G.L.trace("Poll.update_proxy_rating old max, argmax",y,[...b]);var m=y,f=b;if(0==y)this.G.L.trace("Poll.update_proxy_rating voter stops abstaining"),m=l,f=new Set([n]),_.set(n,100),this.T.n_not_abstaining+=1,j=!0;else if(100==y)if(this.G.L.trace("Poll.update_proxy_rating old max was 100"),100==G)if(1==f.size){this.G.L.trace("Poll.update_proxy_rating option decreased from only favourite"),m=-1,f=new Set;for(const D of this.oids){const x=this.proxy_ratings_map.get(D).get(s)||0;x>m?(m=x,f=new Set([D])):x==m&&f.add(D)}if(0==m)this.G.L.trace("Poll.update_proxy_rating voter begins abstaining"),_.set(n,0),this.T.n_not_abstaining-=1,j=!0;else{f.has(n)||_.set(n,l);for(const D of f)D!=n&&_.set(D,100)}}else this.G.L.trace("Poll.update_proxy_rating option decreased from several favourites"),f.delete(n),_.set(n,l);else this.G.L.trace("Poll.update_proxy_rating option changed from non-favourite"),100==l&&f.add(n),_.set(n,l);else if(this.G.L.trace("Poll.update_proxy_rating old max was >0 and <100"),G==m)if(l<G)if(1==f.size){this.G.L.trace("Poll.update_proxy_rating option decreased from only favourite"),m=-1,f=new Set;for(const D of this.oids){const x=this.proxy_ratings_map.get(D).get(s)||0;x>m?(m=x,f=new Set([D])):x==m&&f.add(D)}if(0==m)this.G.L.trace("Poll.update_proxy_rating voter begins abstaining"),_.set(n,0),this.T.n_not_abstaining-=1,j=!0;else{f.has(n)||_.set(n,l);for(const D of f)D!=n&&_.set(D,100)}}else this.G.L.trace("Poll.update_proxy_rating option decreased from several favourites"),f.delete(n),_.set(n,l);else{if(1==f.size)this.G.L.trace("Poll.update_proxy_rating option increased from only favourite");else{this.G.L.trace("Poll.update_proxy_rating option increased from several favourites");for(const D of f)D!=n&&_.set(D,this.proxy_ratings_map.get(D).get(s));f=new Set([n])}m=l}else if(l<G)this.G.L.trace("Poll.update_proxy_rating option decreased from non-favourite"),_.set(n,l);else if(l==m)this.G.L.trace("Poll.update_proxy_rating option increased to several favourites"),f.add(n),_.set(n,100);else if(l>m){this.G.L.trace("Poll.update_proxy_rating option increased to only favourite");for(const D of f)D!=n&&_.set(D,this.proxy_ratings_map.get(D).get(s));m=l,f=new Set([n]),_.set(n,100)}else this.G.L.trace("Poll.update_proxy_rating option increased to non-favourite"),_.set(n,l);if(this.G.L.trace("Poll.update_proxy_rating",j,[..._],y,m,[...b],[...f]),m>0?this.max_proxy_ratings_map.set(s,m):this.max_proxy_ratings_map.delete(s),this.argmax_proxy_ratings_map.set(s,f),_.size>0&&this.update_proxy_rating_phase2(s,j,_,d),v.N.tallying.verify_updates){const D=new Map(this.T.shares_map),x=new Map(this.T.votes_map),S=new Map(this.T.approval_scores_map),A=new Map(this.T.thresholds_map);this.tally_all();for(const M of this.T.shares_map.keys())if(this.T.shares_map.get(M)!=D.get(M))return this.G.L.warn("Poll.update_rating produced inconsistent shares:",[...D],[...this.T.shares_map]),console.log([...x],[...this.T.votes_map]),console.log([...S],[...this.T.approval_scores_map]),void console.log([...A],[...this.T.thresholds_map]);this.G.L.trace("Poll.update_rating produced consistent shares:",[...D],[...this.T.shares_map])}}}update_proxy_rating_phase2(s,n,l,d=!1){this.G.L.entry("Poll.update_proxy_rating_phase2",s,n,this.T.n_not_abstaining,[...l.entries()]);for(const[m,f]of l){var p=this.effective_ratings_map.get(m);p||this.effective_ratings_map.set(m,p=new Map);const j=p.get(s)||0;if(f>0?p.set(s,f):p.delete(s),d){this.G.L.trace("Poll.update_proxy_rating_phase2 update_tally");const y=this.T.effective_ratings_ascending_map.get(m)||[...p.values()];var G;if(0==j)y.push(f),G=y.sort((_,D)=>_-D);else{const _=y.indexOf(j);0==f?G=y.slice(0,_).concat(y.slice(_+1)):(y[_]=f,G=y.sort((D,x)=>D-x))}this.T.effective_ratings_ascending_map.set(m,G),this.G.L.trace("Poll.update_proxy_rating_phase2 ratings_ascending",G);const b=(this.T.total_effective_ratings_map.get(m)||0)+f-j;this.T.total_effective_ratings_map.set(m,b)}}if(d){const m=128*this.T.n_not_abstaining;let f=!1,j=!1,y=!1;const b=n?this.oids:l.keys();for(const S of b){const[A,M,W]=this.update_threshold_and_approvals(S,this.effective_ratings_map.get(S)||new Map,this.T.effective_ratings_ascending_map.get(S)||[]);let R=!1;const K=this.T.approvals_map.get(S);if(!M){const J=((this.effective_ratings_map.get(S)||new Map).get(s)||0)>=A;J!=K.get(s)&&(K.set(s,J),R=!0)}if(R||W){this.G.L.trace("Poll.update_proxy_rating_phase2 approvals changed",S,R,W);const[J,H]=this.update_approval_score(S,K);H&&(y=!0)}this.update_score(S,this.T.approval_scores_map.get(S),this.T.total_effective_ratings_map.get(S),m),W&&(f=!0),R&&(j=!0)}const[_,D]=this.update_ordering();let x=!1;if(D||f){this.G.L.trace("Poll.update_proxy_rating_phase2 updating everyone's votes",D);for(const S of this.T.all_vids_set)this.update_vote(S,_)&&(x=!0)}else j&&(this.G.L.trace("Poll.update_proxy_rating_phase2 updating vid's vote"),x=this.update_vote(s,_));(x||n)&&(this.G.L.trace("Poll.update_proxy_rating_phase2 updating shares",x),this.update_shares(_)&&(y=!0)),y&&(this.G.L.trace("Poll.update_proxy_rating_phase2 pie charts need updating"),this.G.D.page&&"function"==typeof this.G.D.page.show_stats&&this.G.D.page.show_stats())}}update_ratings_ascending(s,n){const l=Array.from(n.values()).sort((p,G)=>p-G),d=Array(this.T.n_not_abstaining-l.length).fill(0).concat(l);return this.T.effective_ratings_ascending_map.set(s,d),d}update_threshold_and_approvals(s,n,l){this.G.L.entry("Poll.update_threshold_and_approvals",s,this.T.n_not_abstaining,[...n],l);let d=100;const p=100/this.T.n_not_abstaining,G=this.T.n_not_abstaining-l.length;for(let y=0;y<l.length;y++){const b=l[y];if(p*(y+G)<b&&b>0){d=b;break}}this.T.approvals_map.has(s)||this.T.approvals_map.set(s,new Map);let m=!1,f=!1;const j=this.T.approvals_map.get(s);if(d!=this.T.thresholds_map.get(s)){this.T.thresholds_map.set(s,d),m=!0;for(const y of this.T.all_vids_set){const _=(n.get(y)||0)>=d;_!=j.get(y)&&(j.set(y,_),f=!0)}}return[d,m,f]}update_approval_score(s,n){const l=Array.from(n.values()).filter(d=>1==d).length;return l!=this.T.approval_scores_map.get(s)?(this.T.approval_scores_map.set(s,l),[l,!0]):[l,!1]}update_score(s,n,l,d){const p=parseFloat("0."+parseInt(this.G.D.hash(this.options[s].name),16).toString());this.T.scores_map.set(s,n*d+l+p)}update_ordering(){const s=[...this.T.scores_map].sort(([l,d],[p,G])=>G-d).map(([l,d])=>l);let n=!1;for(let l=0;l<s.length;l++)if(s[l]!=this.T.oids_descending[l]){n=!0,this.T.oids_descending=s;break}return[s,n]}update_vote(s,n){let l,d=!1;for(const p of n)if((this.T.approvals_map.get(p)||new Map).get(s)){l=p;break}return this.G.L.trace("Poll.update_vote",s,this.T.votes_map.get(s),l),l!=this.T.votes_map.get(s)&&(this.T.votes_map.set(s,l),d=!0),d}update_shares(s){let n=0,l=!1;this.T.n_votes_map.set("",0);for(const d of s)this.T.n_votes_map.set(d,0);for(const d of this.T.all_vids_set){const p=this.T.votes_map.get(d)||"";this.T.n_votes_map.set(p,(this.T.n_votes_map.get(p)||0)+1),""!=p&&n++}if(n>0)for(const d of s){const p=(this.T.n_votes_map.get(d)||0)/n;p!=this.T.shares_map.get(d)&&(this.G.L.trace("PollPage.update_shares",this.pid,d,p),this.T.shares_map.set(d,p),l=!0)}else{const d=s.length;for(const p of s){const G=1/d;G!=this.T.shares_map.get(p)&&(this.G.L.trace("PollPage.update_shares",this.pid,p,G),this.T.shares_map.set(p,G),l=!0)}}return l}end_if_past_due(){const s=new Date,n=this.due,l=!!n&&s>n;return this.G.L.entry("Poll.end_if_past_due",this._pid,s,n,l,this._state),!!l&&(("running"==this._state||"closed"==this._state&&!this.has_results)&&this.end(),!0)}end(){this.G.L.entry("Poll.end",this._pid),this.allow_voting=!1,window.setTimeout((()=>{this.G.L.trace("Poll.end setting state to closed",this._pid),this.state="closed",window.setTimeout((()=>{this.G.L.trace("Poll.end stopping sync",this._pid),this.G.D.stop_poll_sync(this.pid),this.G.D.wait_for_poll_db(this.pid),window.setTimeout((()=>{this.G.L.trace("Poll.end replicating a last time",this._pid),this.G.D.replicate_once(this.pid).then((()=>{this.G.L.trace("Poll.end tally a last time",this._pid),this.tally_all(),"winner"==this.type?(this.G.L.trace("Poll.end getting state doc revision",this._pid),this.G.D.get_remote_poll_state_doc(this.pid).then((s=>{this.G.L.trace("Poll.end making random number",this._pid,s._rev),this.make_final_rand(this.pid+s._rev),this.make_winner(),this.notify_of_end()}).bind(this))):this.notify_of_end()}).bind(this))}).bind(this),v.N.closing.grace_period_3_ms)}).bind(this),v.N.closing.grace_period_2_ms)}).bind(this),v.N.closing.grace_period_1_ms)}make_winner(){if(this.final_rand){this.G.L.entry("Poll.make_winner",this.final_rand,[...this.T.shares_map.entries()]);var s=0;for(const n of this.T.oids_descending)if((s+=this.T.shares_map.get(n))>=this.final_rand)return this.G.L.trace("Poll.make_winner returning",this._pid,n),void(this.winner=n)}}notify_of_end(){this.G.L.trace("Poll.notify_of_end has_been_notified_of_end"),this.has_results=!0,this.have_seen_results=!1,this.G.S.get_notify_of("poll_closed")&&!this.has_been_notified_of_end&&I.s.schedule({notifications:[{title:this.G.translate.instant("notifications.was-closed-title",{title:this.title}),body:this.G.translate.instant("notifications.was-closed-body",{title:this.title,due:this.due_string}),id:null}]}).then(s=>{this.has_been_notified_of_end=!0,this.G.L.trace("Poll.notify_of_end localNotifications.schedule succeeded:",s)}).catch(s=>{this.G.L.warn("Poll.notify_of_end localNotifications.schedule failed:",s)})}make_final_rand(s){var n=0;for(const p of this.oids)n+=this.T.total_effective_ratings_map.get(p)||0;const l=s+(n%100).toString(),d=this.G.D.str2rand(l);this.G.L.trace("PollService.make_final_rand base total r",s,n,d),this.final_rand=d}}class C{constructor(s,n,l=null,d=null,p=null,G=null){this.G=s,this.p=n,l||(l=this.G.P.generate_oid(n.pid),this.G.D.setp(n.pid,"option."+l+".oid",l),this.G.L.trace("...new option",n.pid,l)),this._oid=l,""!=(d||"")&&this.G.D.setp(n.pid,"option."+l+".name",d),""!=(p||"")&&this.G.D.setp(n.pid,"option."+l+".desc",p),""!=(G||"")&&this.G.D.setp(n.pid,"option."+l+".url",G),n._add_option(this)}delete(){this.p.remove_option(this.oid),this.G.D.delp(this.p.pid,"option."+this.oid+".name"),this.G.D.delp(this.p.pid,"option."+this.oid+".desc"),this.G.D.delp(this.p.pid,"option."+this.oid+".url")}get oid(){return this._oid}get name(){return this.G.D.getp(this.p.pid,"option."+this._oid+".name")}set name(s){this.G.D.setp(this.p.pid,"option."+this._oid+".name",s)}get desc(){return this.G.D.getp(this.p.pid,"option."+this._oid+".desc")}set desc(s){this.G.D.setp(this.p.pid,"option."+this._oid+".desc",s)}get url(){return this.G.D.getp(this.p.pid,"option."+this._oid+".url")}set url(s){this.G.D.setp(this.p.pid,"option."+this._oid+".url",s)}}},2340:($,V,c)=>{"use strict";c.d(V,{N:()=>I});const I={LEAVE_THIS_AS_THE_FIRST_ENTRY:!0,production:!0,imprint_url:"./assets/impressum.html",privacy_statement_url:"./assets/privacy.html",privacy_statement_headline:"Formal Privacy Policy and Terms of Use",logging:{logLevels:[{loggerName:"root",logLevel:"ERROR"}]},show_debug_info:!1,data_service:{central_db_server_url:"https://sandstorm.pik-potsdam.de/couch/",central_db_password:"none",allow_other_servers:!1,hash_n_bytes:32,pid_length:8,pwd_length:16,oid_length:4,vid_length:8,did_length:8,nid_length:4},delegation:{enabled:!1,max_weight:10},db_put_retry_delay_ms:100,default_lang:"en",github_url:"https://github.com/pik-gane/vodle",magic_link_base_url:"https://sandstorm.pik-potsdam.de/#/",support_vodle_url:"http://vodle.it/#support",tallying:{verify_updates:!1},closing:{grace_period_1_ms:3e3,grace_period_2_ms:3e3,grace_period_3_ms:3e3},max_len:{title:200,name:100,desc:1e3,url:200},polls:{max_duration_days:31,delete_after_days:31},LEAVE_THIS_AS_THE_LAST_ENTRY:!0}},2865:($,V,c)=>{"use strict";var I=c(4497),v=c(2135),N=c(6476),z=c(2004),Q=c(8987),Y=c(8139),q=c(2202),C=c(6903),Z=c(4043),s=c(2340),n=c(4666);const l=function(_){return[_]};function d(_,D){if(1&_&&(v.TgZ(0,"ion-menu-toggle",5)(1,"ion-item",6),v._UZ(2,"ion-icon",7),v.TgZ(3,"ion-label"),v._uU(4),v.ALo(5,"translate"),v.qZA()()()),2&_){const x=D.$implicit;v.xp6(1),v.Q6J("routerDirection","root")("routerLink",v.VKq(6,l,x.url)),v.xp6(1),v.Q6J("name",x.icon),v.xp6(2),v.hij(" ",v.lcZ(5,4,x.title)," ")}}let p=(()=>{class _{constructor(x,S){this.document=S,this.appPages=[{title:"mypolls.-page-title",url:"/mypolls",icon:"home"},{title:"settings.-page-title",url:"/settings",icon:"settings"},{title:"help.-page-title",url:"/help",icon:"help-circle"},{title:"about.-page-title",url:"/about",icon:"information-circle-outline"},{title:"privacy.-page-title",url:"/privacy",icon:"shield-checkmark-outline"},{title:"imprint.-page-title",url:"/imprint",icon:"at-outline"},{title:"delete-all.-page-title",url:"/delete-all",icon:"trash-outline"},{title:"logout.-page-title",url:"/logout",icon:"log-out"}],console.log("APP CONSTRUCTOR"),x.addLangs(["de","en","es","fi","hi","ko","pl","zh"]),x.setDefaultLang("en");const A=navigator.language.slice(0,2),M=x.langs.includes(A)?A:"en";x.use(M),this.document.documentElement.lang=M}}return _.\u0275fac=function(x){return new(x||_)(v.Y36(Y.sK),v.Y36(n.K0))},_.\u0275cmp=v.Xpm({type:_,selectors:[["app-root"]],decls:12,vars:1,consts:[["contentId","main"],["href","http://www.vodle.it"],["src","./assets/topleft_icon.svg","height","40px","alt","vodle"],["auto-hide","false",4,"ngFor","ngForOf"],["id","main"],["auto-hide","false"],[3,"routerDirection","routerLink"],["slot","start",3,"name"]],template:function(x,S){1&x&&(v.TgZ(0,"ion-app")(1,"ion-split-pane",0)(2,"ion-menu",0)(3,"ion-header")(4,"ion-toolbar")(5,"ion-title")(6,"a",1),v._UZ(7,"img",2),v.qZA()()()(),v.TgZ(8,"ion-content")(9,"ion-list"),v.YNc(10,d,6,8,"ion-menu-toggle",3),v.qZA()()(),v._UZ(11,"ion-router-outlet",4),v.qZA()()),2&x&&(v.xp6(10),v.Q6J("ngForOf",S.appPages))},dependencies:[n.sg,z.dr,z.W2,z.Gu,z.gu,z.Ie,z.Q$,z.q_,z.z0,z.zc,z.jI,z.wd,z.sr,z.jP,z.YI,N.rH,Y.X$],styles:['@charset "UTF-8";']}),_})();const G=[{path:"",redirectTo:"/mypolls",pathMatch:"full"},{path:"about",loadChildren:()=>c.e(197).then(c.bind(c,197)).then(_=>_.AboutPageModule)},{path:"delrespond/:pid/:did/:from/:private_key",loadChildren:()=>c.e(1437).then(c.bind(c,1437)).then(_=>_.DelrespondPageModule)},{path:"draftpoll",loadChildren:()=>Promise.all([c.e(8592),c.e(9701)]).then(c.bind(c,9701)).then(_=>_.DraftpollPageModule)},{path:"draftpoll/:pid",loadChildren:()=>Promise.all([c.e(8592),c.e(9701)]).then(c.bind(c,9701)).then(_=>_.DraftpollPageModule)},{path:"draftpoll/use/:pd",loadChildren:()=>Promise.all([c.e(8592),c.e(9701)]).then(c.bind(c,9701)).then(_=>_.DraftpollPageModule)},{path:"draftpoll-kebap",loadChildren:()=>c.e(8592).then(c.bind(c,3357)).then(_=>_.DraftpollKebapPageModule)},{path:"help",loadChildren:()=>c.e(9675).then(c.bind(c,9675)).then(_=>_.HelpPageModule)},{path:"inviteto/:pid",loadChildren:()=>c.e(2377).then(c.bind(c,2377)).then(_=>_.InvitetoPageModule)},{path:"joinpoll/:db_server_url/:db_password/:pid/:poll_password",loadChildren:()=>c.e(2172).then(c.bind(c,2172)).then(_=>_.JoinpollPageModule)},{path:"mypolls",loadChildren:()=>c.e(7608).then(c.bind(c,7608)).then(_=>_.MypollsPageModule)},{path:"poll/:pid",loadChildren:()=>Promise.all([c.e(1353),c.e(8581),c.e(2459),c.e(8592),c.e(5654)]).then(c.bind(c,5654)).then(_=>_.PollPageModule)},{path:"p/:pid",loadChildren:()=>Promise.all([c.e(1353),c.e(8581),c.e(2459),c.e(8592),c.e(5654)]).then(c.bind(c,5654)).then(_=>_.PollPageModule)},{path:"settings",loadChildren:()=>Promise.all([c.e(8592),c.e(451)]).then(c.bind(c,451)).then(_=>_.SettingsPageModule)},{path:"previewpoll/:pid",loadChildren:()=>c.e(5004).then(c.bind(c,5004)).then(_=>_.PreviewpollPageModule)},{path:"login",loadChildren:()=>c.e(4987).then(c.bind(c,4987)).then(_=>_.LoginPageModule)},{path:"login/:step",loadChildren:()=>c.e(4987).then(c.bind(c,4987)).then(_=>_.LoginPageModule)},{path:"login/:step/:then",loadChildren:()=>c.e(4987).then(c.bind(c,4987)).then(_=>_.LoginPageModule)},{path:"configure-server",loadChildren:()=>c.e(9076).then(c.bind(c,9076)).then(_=>_.ConfigureServerPageModule)},{path:"logout",loadChildren:()=>c.e(7651).then(c.bind(c,7651)).then(_=>_.LogoutPageModule)},{path:"delegation-dialog",loadChildren:()=>c.e(2459).then(c.bind(c,2459)).then(_=>_.DelegationDialogPageModule)},{path:"addoption-dialog",loadChildren:()=>c.e(8592).then(c.bind(c,2122)).then(_=>_.AddoptionDialogPageModule)},{path:"explain-approval",loadChildren:()=>c.e(1353).then(c.bind(c,1353)).then(_=>_.ExplainApprovalPageModule)},{path:"privacy",loadChildren:()=>c.e(50).then(c.bind(c,50)).then(_=>_.PrivacyPageModule)},{path:"imprint",loadChildren:()=>c.e(3305).then(c.bind(c,3305)).then(_=>_.ImprintPageModule)},{path:"delete-all",loadChildren:()=>c.e(7795).then(c.bind(c,7795)).then(_=>_.DeleteAllPageModule)},{path:"*",redirectTo:"/mypolls"},{path:"assist",loadChildren:()=>c.e(8581).then(c.bind(c,8581)).then(_=>_.AssistPageModule)}];let m=(()=>{class _{}return _.\u0275fac=function(x){return new(x||_)},_.\u0275mod=v.oAB({type:_}),_.\u0275inj=v.cJS({imports:[N.Bz.forRoot(G,{preloadingStrategy:N.wm}),N.Bz]}),_})();var f=c(2518);function j(_){return new q.w(_,"./assets/i18n/",".json")}function y(_){return()=>{console.log("VODLE configuring logger with "+JSON.stringify(s.N.logging)),_.configure(s.N.logging)}}let b=(()=>{class _{}return _.\u0275fac=function(x){return new(x||_)},_.\u0275mod=v.oAB({type:_,bootstrap:[p]}),_.\u0275inj=v.cJS({providers:[{provide:N.wN,useClass:z.r4},{provide:n.S$,useClass:n.Do},f.U,{deps:[C.ed],multi:!0,provide:v.ip1,useFactory:y}],imports:[C.Lo,I.b2,z.Pc.forRoot(),Z.Fw.forRoot(),m,Q.JF,Y.aw.forRoot({defaultLanguage:"en",loader:{provide:Y.Zw,useFactory:j,deps:[Q.eN]}})]}),_})();s.N.production&&(0,v.G48)(),I.q6().bootstrapModule(b).catch(_=>console.log(_))},863:($,V,c)=>{var I={"./ion-accordion_2.entry.js":[79,8592,79],"./ion-action-sheet.entry.js":[5593,8592,5593],"./ion-alert.entry.js":[3225,8592,3225],"./ion-app_8.entry.js":[4812,8592,4017],"./ion-avatar_3.entry.js":[6655,6655],"./ion-back-button.entry.js":[4856,8592,4856],"./ion-backdrop.entry.js":[3059,3059],"./ion-breadcrumb_2.entry.js":[8648,8592,8648],"./ion-button_2.entry.js":[8308,8308],"./ion-card_5.entry.js":[4690,4690],"./ion-checkbox.entry.js":[4090,4090],"./ion-chip.entry.js":[6214,6214],"./ion-col_3.entry.js":[9447,9447],"./ion-datetime-button.entry.js":[7950,5523,7950],"./ion-datetime_3.entry.js":[9689,5523,8592,9689],"./ion-fab_3.entry.js":[8840,8592,8840],"./ion-img.entry.js":[749,749],"./ion-infinite-scroll_2.entry.js":[9667,8592,9544],"./ion-input.entry.js":[3288,3288],"./ion-item-option_3.entry.js":[5473,8592,6108],"./ion-item_8.entry.js":[3634,8592,3634],"./ion-loading.entry.js":[2855,8592,2855],"./ion-menu_3.entry.js":[495,8592,495],"./ion-modal.entry.js":[8737,8592,8737],"./ion-nav_2.entry.js":[9632,8592,9632],"./ion-picker-column-internal.entry.js":[4446,8592,4446],"./ion-picker-internal.entry.js":[2275,2275],"./ion-popover.entry.js":[8050,8592,8050],"./ion-progress-bar.entry.js":[8994,8994],"./ion-radio_2.entry.js":[3592,3592],"./ion-range.entry.js":[5454,8592,5454],"./ion-refresher_2.entry.js":[290,8592,4210],"./ion-reorder_2.entry.js":[2666,8592,8718],"./ion-ripple-effect.entry.js":[4816,4816],"./ion-route_4.entry.js":[5534,5534],"./ion-searchbar.entry.js":[4902,8592,4902],"./ion-segment_2.entry.js":[1938,8592,1938],"./ion-select_3.entry.js":[8179,8179],"./ion-slide_2.entry.js":[668,668],"./ion-spinner.entry.js":[1624,8592,1624],"./ion-split-pane.entry.js":[9989,9989],"./ion-tab-bar_2.entry.js":[8902,8592,8902],"./ion-tab_2.entry.js":[199,8592,199],"./ion-text.entry.js":[8395,8395],"./ion-textarea.entry.js":[6357,6357],"./ion-toast.entry.js":[8268,8592,8268],"./ion-toggle.entry.js":[5269,8592,5269],"./ion-virtual-scroll.entry.js":[2875,2875]};function v(N){if(!c.o(I,N))return Promise.resolve().then(()=>{var Y=new Error("Cannot find module '"+N+"'");throw Y.code="MODULE_NOT_FOUND",Y});var z=I[N],Q=z[0];return Promise.all(z.slice(1).map(c.e)).then(()=>c(Q))}v.keys=()=>Object.keys(I),v.id=863,$.exports=v},4198:()=>{},5992:()=>{},8110:()=>{}},$=>{$.O(0,[4736],()=>$($.s=2865)),$.O()}]);
//# sourceMappingURL=main.addd8e47de302a69.js.map