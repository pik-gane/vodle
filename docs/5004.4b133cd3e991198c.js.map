{"version":3,"mappings":"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","names":["i0","ctx_r10","ctx_r16","ctx_r19","routes","path","component","constructor","router","route","translate","G","this","Object","L","entry","params","subscribe","pid","ngOnInit","ionViewWillEnter","D","page","ionViewDidEnter","ready","onDataReady","debug","P","polls","p","set_due","update_ref_date","state","warn","navigate","info","ionViewDidLeave","save_state","exit","publish_button_clicked","set_db_credentials","init_password","init_myvid","start_date","Date","wait_for_user_db","finally","wait_for_poll_db","init_myratings","creator","S","email","trace","is_test","getp","oid","oids","ratings","JSON","parse","Array","isArray","i","vid","r","setv_in_polldb","update_own_rating","tally_all","PreviewpollPage","selectors","PreviewpollPageRoutingModule","RouterModule","PreviewpollPageModule","CommonModule","FormsModule","IonicModule","TranslateModule"],"sources":["./src/app/previewpoll/previewpoll.page.html","./src/app/previewpoll/previewpoll-routing.module.ts","./src/app/previewpoll/previewpoll.page.ts","./src/app/previewpoll/previewpoll.module.ts"],"sourcesContent":["<!--\n(C) Copyright Potsdam Institute for Climate Impact Research (PIK).\n\nThis file is part of vodle.\n\nvodle is free software: you can redistribute it and/or modify it under the \nterms of the GNU Affero General Public License as published by the Free \nSoftware Foundation, either version 3 of the License, or (at your option) \nany later version.\n\nvodle is distributed in the hope that it will be useful, but WITHOUT ANY \nWARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR \nA PARTICULAR PURPOSE. See the GNU Affero General Public License for more \ndetails.\n\nYou should have received a copy of the GNU Affero General Public License \nalong with vodle. If not, see <https://www.gnu.org/licenses/>. \n-->\n\n<ion-header>\n  <ion-toolbar style=\"padding-right:11px;\">\n    <ion-buttons slot=\"start\">\n      <ion-menu-button></ion-menu-button>\n    </ion-buttons>\n    <ion-title [innerHtml]=\"'previewpoll.-page-title'|translate\"></ion-title>\n  </ion-toolbar>\n</ion-header>\n\n<ion-content *ngIf=\"ready && (p!=null)\">\n  <ion-list lines=\"full\">\n    <ion-item>\n      <ion-col class=\"ion-no-padding ion-no-margin\">\n        <p>\n          <ion-text [innerHtml]=\"'previewpoll.type-label'|translate\"></ion-text>&nbsp;<ion-text color=\"primary\"\n            [innerHtml]=\"('draftpoll.type-'+p.type|translate)+'.'\"></ion-text>\n        </p>\n        <ion-text color=\"primary\"><h3>\n          <span style=\"position:relative;top:3px;z-index:10;\">\n            <ion-icon color=\"primary\"\n              [name]=\"p.type=='winner'?'trophy':'cut'\">\n            </ion-icon>&nbsp;\n          </span>\n          <b><i [innerHtml]=\"p.title\"></i></b>\n        </h3></ion-text>\n        <p *ngIf=\"((p.desc||'')!='')||((p.url||'')!='')\">\n          <ion-text *ngIf=\"(p.desc||'')!=''\" color=\"primary\"><i [innerHtml]=\"p.desc\"></i></ion-text>\n          <ion-text *ngIf=\"(p.url||'')!=''\" style=\"font-size: smaller;\" color=\"primary\"><span *ngIf=\"((p.desc||'')!='')&&((p.url||'')!='')\">&nbsp;</span>\n            (<span  (click)=\"G.open_url_in_new_tab(G.D.fix_url(p.url))\"><ion-text class=\"externallink\" [innerHtml]=\"'read-more'|translate\"></ion-text>&nbsp;<ion-icon name=\"open-outline\" style=\"position: relative; top: 2px;\"></ion-icon></span>)\n          </ion-text>\n        </p>\n        <p>\n          <ng-container *ngIf=\"p.due >= G.P.ref_date\">\n            <ion-text [innerHtml]=\"'previewpoll.closes'|translate\"></ion-text>&nbsp;<ion-text color=\"primary\" [innerHtml]=\"((p.due_type!='custom')?('draftpoll.due-type-'+p.due_type|translate):G.D.format_date(p.due))\"></ion-text>\n          </ng-container>\n          <ion-text *ngIf=\"p.due < G.P.ref_date\" [innerHtml]=\"'previewpoll.is-in-past'|translate\" style=\"color: red;\"></ion-text>\n        </p>\n        <p *ngIf=\"((p.language||'')!='') && (p.language!=G.S.language)\">\n          <small>\n            <ion-text [innerHtml]=\"'draftpoll.language'|translate\"></ion-text>:&nbsp;<ion-text color=\"primary\" [innerHtml]=\"G.S.language_names[p.language]\"></ion-text>\n          </small>\n        </p>\n        <p *ngIf=\"p.db!='default'\">\n          <ion-select-option value=\"central\" [innerHtml]=\"'select-server.central'|translate\"></ion-select-option>\n          <ion-select-option value=\"poll\" [innerHtml]=\"(page=='settings'?'select-server.same-as-some-poll':'select-server.same-as-other-poll')|translate\"></ion-select-option>\n          <ion-select-option value=\"other\" [innerHtml]=\"'select-server.other'|translate\"></ion-select-option>\n              <small>\n            <ion-text [innerHtml]=\"'previewpoll.db-label'|translate\"></ion-text>:&nbsp;<ion-text color=\"primary\" [innerHtml]=\"(p.db=='poll'?'select-server.same-as-other-poll':p.db=='central'?'select-server.central':'select-server.other')|translate\"></ion-text>\n          </small>\n        </p>\n        <p>\n          <small>\n            <b>\n              <ion-text [innerHtml]=\"(p.type=='winner' ? 'options' : 'possible-targets')|translate\"></ion-text>:\n            </b>\n          </small>\n        </p>\n      </ion-col>\n    </ion-item>\n\n    <!-- OPTIONS: -->\n    <ion-item *ngFor=\"let o of Object.values(p.options)\">\n      <ion-col class=\"ion-no-padding ion-no-margin\">\n        <p>\n          <ion-text color=\"primary\"><b><i [innerHtml]=\"o.name\"></i></b></ion-text>\n          <ion-text *ngIf=\"(o.desc||'')!=''\" color=\"primary\"><br/><i [innerHtml]=\"o.desc\"></i></ion-text>\n          <ion-text *ngIf=\"(o.url||'')!=''\" style=\"font-size: smaller;\" color=\"primary\">&nbsp;\n            (<span (click)=\"G.open_url_in_new_tab(G.D.fix_url(o.url))\"><ion-text class=\"externallink\" [innerHtml]=\"'read-more'|translate\"></ion-text>&nbsp;<ion-icon name=\"open-outline\" style=\"position: relative; top: 2px;\"></ion-icon></span>)\n          </ion-text>            \n        </p>\n      </ion-col>\n    </ion-item>\n    \n    <ion-item lines=\"none\">\n      <ion-col class=\"ion-no-padding ion-no-margin\">\n        <p [innerHtml]=\"'previewpoll.caution1'|translate\"></p> \n        <small><p [innerHtml]=\"'previewpoll.caution2'|translate\"></p></small> \n      </ion-col>      \n    </ion-item>\n    <ion-item \n        lines=\"none\" class=\"ion-text-end\" text-wrap>\n      <ion-button size=\"large\" color=\"primary\" slot=\"end\" [disabled]=\"p.due < G.P.ref_date\" \n          shape=\"round\"\n          (click)=\"publish_button_clicked()\">\n        <span [innerHtml]=\"'previewpoll.publish'|translate\"></span>&nbsp;\n        <ion-icon name=\"paper-plane\"></ion-icon>\n      </ion-button>\n    </ion-item>\n  </ion-list>\n</ion-content>\n","/*\n(C) Copyright Potsdam Institute for Climate Impact Research (PIK).\n\nThis file is part of vodle.\n\nvodle is free software: you can redistribute it and/or modify it under the \nterms of the GNU Affero General Public License as published by the Free \nSoftware Foundation, either version 3 of the License, or (at your option) \nany later version.\n\nvodle is distributed in the hope that it will be useful, but WITHOUT ANY \nWARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR \nA PARTICULAR PURPOSE. See the GNU Affero General Public License for more \ndetails.\n\nYou should have received a copy of the GNU Affero General Public License \nalong with vodle. If not, see <https://www.gnu.org/licenses/>. \n*/\n\nimport { NgModule } from '@angular/core';\nimport { Routes, RouterModule } from '@angular/router';\n\nimport { PreviewpollPage } from './previewpoll.page';\n\nconst routes: Routes = [\n  {\n    path: '',\n    component: PreviewpollPage\n  }\n];\n\n@NgModule({\n  imports: [RouterModule.forChild(routes)],\n  exports: [RouterModule],\n})\nexport class PreviewpollPageRoutingModule {}\n","/*\n(C) Copyright Potsdam Institute for Climate Impact Research (PIK).\n\nThis file is part of vodle.\n\nvodle is free software: you can redistribute it and/or modify it under the \nterms of the GNU Affero General Public License as published by the Free \nSoftware Foundation, either version 3 of the License, or (at your option) \nany later version.\n\nvodle is distributed in the hope that it will be useful, but WITHOUT ANY \nWARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR \nA PARTICULAR PURPOSE. See the GNU Affero General Public License for more \ndetails.\n\nYou should have received a copy of the GNU Affero General Public License \nalong with vodle. If not, see <https://www.gnu.org/licenses/>. \n*/\n\nimport { Component, OnInit } from '@angular/core';\nimport { Router, ActivatedRoute } from '@angular/router';\nimport { TranslateService } from '@ngx-translate/core';\n\nimport { GlobalService } from \"../global.service\";\nimport { Poll } from '../poll.service';\n\n@Component({\n  selector: 'app-previewpoll',\n  templateUrl: './previewpoll.page.html',\n  styleUrls: ['./previewpoll.page.scss'],\n})\nexport class PreviewpollPage implements OnInit {\n\n  Object = Object;\n  page = \"previewpoll\";\n\n  pid: string;\n  p: Poll;\n\n  // LIFECYCLE:\n\n  ready = false;  \n  \n  constructor(\n      public router: Router,\n      private route: ActivatedRoute,\n      public translate: TranslateService,\n      public G: GlobalService) {\n    this.G.L.entry(\"PreviewpollPage.constructor\");\n    this.route.params.subscribe( params => { \n      this.pid = params['pid'];\n    } );\n  }\n\n  ngOnInit() {\n    this.G.L.entry(\"PreviewpollPage.ngOnInit\");\n  }\n\n  ionViewWillEnter() {\n    this.G.L.entry(\"PreviewpollPage.ionViewWillEnter\");\n    this.G.D.page = this;\n  }\n\n  ionViewDidEnter() {\n    this.G.L.entry(\"PreviewpollPage.ionViewDidEnter\");\n    if (this.G.D.ready) {\n      this.onDataReady();\n    }\n    this.G.L.debug(\"PreviewpollPage.ready:\", this.ready);\n  }\n\n  onDataReady() {\n    // called when DataService initialization was slower than view initialization\n    this.G.L.entry(\"PreviewpollPage.onDataReady\");\n    if (this.pid in this.G.P.polls) {\n      this.p = this.G.P.polls[this.pid];\n      this.p.set_due();\n      this.G.P.update_ref_date();\n      if (this.p.state == 'draft') {\n        this.G.L.info(\"PreviewpollPage showing existing draft\", this.pid);\n      } else {\n        this.G.L.warn(\"DraftpollPage non-draft pid ignored, redirecting to mypolls page\", this.pid);\n        this.router.navigate([\"/mypolls\"]);\n        return;\n      }\n    } else {\n      this.G.L.warn(\"PreviewpollPage unknown pid ignored, redirecting to mypolls page\", this.pid, this.G.P.polls);\n      this.router.navigate([\"/mypolls\"]);\n      return;\n    }\n    this.ready = true;\n  }\n\n  ionViewDidLeave() {\n    this.G.L.entry(\"PreviewpollPage.ionViewDidLeave\");\n    this.G.D.save_state();\n    this.G.L.exit(\"PreviewpollPage.ionViewDidLeave\");\n  }\n\n  // HOOKS:\n\n  publish_button_clicked() {\n    this.G.L.entry(\"PreviewpollPage.publish_button_clicked\");\n    // TODO: \n    // - again check that due is in future!\n    // - show spinner while busy!\n    // fix db credentials:\n    this.p.set_db_credentials();\n    // generate a random poll password:\n    this.p.init_password();\n    // register the user herself as a voter in the poll:\n    this.p.init_myvid();\n    this.p.start_date = new Date();\n    // wait for these changes to user db to be finished before continuing!\n    this.G.D.wait_for_user_db().finally(() => {\n      // set state to running, which will cause the poll data to be stored in the designated server:\n      this.p.state = 'running';\n      // wait for these changes to poll db to be finished before continuing!\n      this.G.D.wait_for_poll_db(this.pid).finally(() => {\n        // set own ratings to zero:\n        this.p.init_myratings();\n        this.p.creator = this.G.S.email;\n        // if test, register simulated voters:\n        this.G.L.trace(\"PreviewpollPage.publish_button_clicked poll is_test\", this.p.is_test, this.G.D.getp(this.pid, 'is_test'));\n        if (this.p.is_test) {\n          for (const oid of this.p.oids) {\n            const ratings = JSON.parse(this.G.D.getp(this.pid, 'simulated_ratings.'+oid));\n            if (Array.isArray(ratings)) {\n              this.G.L.trace(\"PreviewpollPage.publish_button_clicked registering simulated voters...\");\n              for (const i in ratings) {\n                const vid = \"simulated\"+i,\n                      r = ratings[i];\n                this.G.D.setv_in_polldb(this.pid, 'rating.'+oid, r, vid);\n                this.G.P.update_own_rating(this.pid, vid, oid, r, false);\n                this.G.L.trace(\"PreviewpollPage.publish_button_clicked registered simulated voter\", i);\n              }\n            }\n          }\n          this.p.tally_all();\n        }\n        // go to invitation page:\n        this.router.navigate(['/inviteto/'+this.pid]);\n        this.G.L.exit(\"PreviewpollPage.publish_button_clicked\");\n      });\n    });\n  }\n\n}\n","/*\n(C) Copyright Potsdam Institute for Climate Impact Research (PIK).\n\nThis file is part of vodle.\n\nvodle is free software: you can redistribute it and/or modify it under the \nterms of the GNU Affero General Public License as published by the Free \nSoftware Foundation, either version 3 of the License, or (at your option) \nany later version.\n\nvodle is distributed in the hope that it will be useful, but WITHOUT ANY \nWARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR \nA PARTICULAR PURPOSE. See the GNU Affero General Public License for more \ndetails.\n\nYou should have received a copy of the GNU Affero General Public License \nalong with vodle. If not, see <https://www.gnu.org/licenses/>. \n*/\n\nimport { NgModule } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { FormsModule } from '@angular/forms';\nimport { TranslateModule } from '@ngx-translate/core';\n\nimport { IonicModule } from '@ionic/angular';\n\nimport { PreviewpollPageRoutingModule } from './previewpoll-routing.module';\n\nimport { PreviewpollPage } from './previewpoll.page';\n\n@NgModule({\n  imports: [\n    CommonModule,\n    FormsModule,\n    IonicModule,\n    PreviewpollPageRoutingModule,\n    TranslateModule.forChild()\n  ],\n  declarations: [PreviewpollPage]\n})\nexport class PreviewpollPageModule {}\n"],"sourceRoot":"webpack:///","file":"5004.4b133cd3e991198c.js"}